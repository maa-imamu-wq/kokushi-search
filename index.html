<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å›½è©¦åˆ†æ</title>
  <style>
    /* UI refresh: header/side nav/cards/table/accordion/toast */
    :root {
      --bg: #f6f2eb;
      --card: #ffffff;
      --text: #1c1b18;
      --muted: #6f675c;
      --primary: #1f6b5f;
      --primary-strong: #175148;
      --secondary: #ebe4da;
      --border: #e3dbd0;
      --chip-bg: #f7f2eb;
      --sidebar: #efe7db;
      --shadow: 0 8px 20px rgba(26, 22, 18, 0.08);
      --radius: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Hiragino Sans", "Yu Gothic", "Meiryo", "Noto Sans JP", sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
    }

    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 1000;
      box-shadow: 0 6px 14px rgba(26, 22, 18, 0.06);
    }

    .top-nav {
      display: flex;
      gap: 12px;
      padding: 12px 24px;
      background: var(--sidebar);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 64px;
      z-index: 900;
    }

    .top-nav button {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: var(--chip-bg);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .top-nav button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .brand {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.08em;
    }

    .view-label {
      font-size: 0.85rem;
      color: var(--muted);
      background: var(--chip-bg);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
    }

    .app-shell {
      min-height: 100vh;
      padding-top: 64px;
    }

    .sidebar {
      width: 220px;
      background: var(--sidebar);
      border-right: 1px solid var(--border);
      padding: 20px 16px;
      position: sticky;
      top: 64px;
      height: calc(100vh - 64px);
      overflow-y: auto;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .nav button {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: var(--chip-bg);
      cursor: pointer;
      font-size: 0.92rem;
      text-align: left;
      transition: all 0.2s ease;
    }

    .nav button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 6px 12px rgba(31, 107, 95, 0.24);
    }

    .main {
      flex: 1;
      padding: 24px 28px 40px;
      max-width: 1440px;
      margin: 0 auto;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .view-header {
      margin-bottom: 16px;
    }

    .view-title {
      font-size: 1.5rem;
      margin: 0 0 6px;
    }

    .subtitle {
      color: var(--muted);
      margin: 0;
      font-size: 0.9rem;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    .card.compact {
      padding: 12px;
    }

    .section-title {
      font-weight: 600;
      margin: 0 0 6px;
      color: var(--text);
    }

    .search-box {
      border: none;
      padding: 0;
      margin: 0;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text);
    }

    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 0.95rem;
      background: #fff;
      color: var(--text);
      font-family: inherit;
    }

    textarea {
      min-height: 120px;
      box-sizing: border-box;
    }

    /* A-2 ã®æ—§ãƒ»RBCåæ¤œç´¢æ¬„ã¯ãƒ­ã‚¸ãƒƒã‚¯ç”¨ã«æ®‹ã—ã¤ã¤ç”»é¢ã«ã¯è¡¨ç¤ºã—ãªã„ */
    label[for="rbcInput"],
    #rbcInput,
    #searchButton,
    #clearButton {
      display: none;
    }

    /* A-4 ã¯ç« ã‚’ã‚¿ãƒ–ï¼ˆãƒœã‚¿ãƒ³ï¼‰ã§é¸ã¶ãŸã‚ã€select ã¯éè¡¨ç¤ºï¼ˆãƒ­ã‚¸ãƒƒã‚¯ç”¨ã«æ®‹ã™ï¼‰ */
    label[for="a4ChapterSelect"],
    #a4ChapterSelect {
      display: none;
    }

    /* A-4: åŸºæº–ã¯è¡¨ã®è¦‹å‡ºã—ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã€select/tabsã¯éè¡¨ç¤ºï¼ˆãƒ­ã‚¸ãƒƒã‚¯ç”¨ã«æ®‹ã™ï¼‰ */
    label[for="a4BasisSelect"],
    #a4BasisSelect,
    #a4BasisTabs,
    .a4-basis-tabs {
      display: none;
    }

    th.a4-sortable {
      cursor: pointer;
      user-select: none;
    }
    th.a4-sortable:hover {
      text-decoration: underline;
    }
    .a4-selected-col {
      background: rgba(31, 107, 95, 0.10);
    }

    button.primary,
    button.secondary {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    button.primary {
      background-color: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    button.primary:hover {
      background-color: var(--primary-strong);
      border-color: var(--primary-strong);
    }

    button.secondary {
      background-color: var(--secondary);
      color: var(--text);
      border-color: var(--border);
    }

    button.secondary:hover {
      background-color: #dfd5c8;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .tab-button {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip-bg);
      cursor: pointer;
      font-size: 0.82rem;
      transition: all 0.2s ease;
    }

    .tab-button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .mini-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
      /* ç« ã‚¿ãƒ–ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ã—ã¦ã€ä¸‹æ®µï¼ˆåˆè¨ˆ/å†…è¨³ï¼‰ã‚’ä¸Šã«å¯„ã›ã‚‹ */
      margin-top: 2px;
    }

    .mini-tab-button {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--chip-bg);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 0;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1;
    }

    .mini-tab-button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .result-count {
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .no-result {
      margin-top: 12px;
      color: #b42318;
      font-size: 0.9rem;
    }

    #results,
    #a4RankingTable {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.9rem;
      min-width: 720px;
    }

    th,
    td {
      border-bottom: 1px solid var(--border);
      padding: 10px 12px;
      text-align: left;
    }

    th {
      background-color: var(--chip-bg);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr[onclick] {
      cursor: pointer;
    }

    tr[onclick]:hover {
      background: #f0e9df;
    }

    #a3Body {
      margin-top: 4px;
    }

    #a3Comment p {
      margin: 4px 0;
    }

    .a2-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .a2-filters {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }

    .a2-filter-col {
      min-width: 240px;
    }

    .a2-filter-col .tabs {
      margin-bottom: 0;
    }

    .summary-box {
      background: transparent;
      border: none;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .is-hidden {
      display: none !important;
    }

    .summary-item {
      background: var(--chip-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
      box-shadow: 0 2px 8px rgba(26, 22, 18, 0.04);
    }

    .summary-item .section-title {
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .summary-item .summary-value {
      font-size: 0.98rem;
      font-weight: 600;
      color: var(--text);
      line-height: 1.5;
      word-break: break-word;
    }

    .summary-item.wide {
      grid-column: 1 / -1;
    }

    @media (max-width: 900px) {
      .summary-box {
        grid-template-columns: 1fr;
      }
    }

    .a3-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #a3Code {
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .a3-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* A-3: é¸æŠè‚¢/è§£ç­”/æ­£ç­”ç‡ã‚’1ã‚«ãƒ¼ãƒ‰ã«çµ±åˆ */
    .a3-choice-box {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 14px;
      align-items: start;
    }

    .a3-choice-left {
      min-width: 0;
    }

    .a3-choice-right {
      display: grid;
      grid-template-rows: auto auto;
      gap: 14px;
      min-width: 0;
    }

    .a3-choice-right-top,
    .a3-choice-right-bottom {
      background: var(--chip-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(26, 22, 18, 0.04);
    }

    @media (max-width: 900px) {
      .a3-choice-box {
        grid-template-columns: 1fr;
      }
    }

    .section-card {
      padding: 16px;
    }

    .accordion-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 10px;
      background: #fff;
      overflow: hidden;
    }

    .accordion-item summary {
      list-style: none;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 600;
      background: var(--chip-bg);
    }

    .accordion-item summary::-webkit-details-marker {
      display: none;
    }

    .accordion-item[open] summary {
      border-bottom: 1px solid var(--border);
    }

    .accordion-body {
      padding: 12px;
    }

    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: var(--text);
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(8px);
      transition: all 0.2s ease;
      z-index: 1100;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    @media (max-width: 900px) {
      .app-shell {
        flex-direction: column;
      }

      .main {
        padding: 16px;
      }

      .a2-filters {
        grid-template-columns: 1fr;
      }

      .top-nav {
        flex-wrap: wrap;
      }
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #141311;
        --card: #1f1d1a;
        --text: #f2eee8;
        --muted: #b5afa6;
        --primary: #5ac4ad;
        --primary-strong: #3aa68f;
        --secondary: #2a261f;
        --border: #332f28;
        --chip-bg: #2a261f;
        --sidebar: #1a1714;
        --shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      }

      input[type="text"],
      select,
      textarea {
        background: #1f1d1a;
        color: var(--text);
      }

      tr[onclick]:hover {
        background: #2a261f;
      }
    }

    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .image-tile {
      border: none;
      border-radius: 0;
      overflow: hidden;
      background: transparent;
    }

    .image-tile img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
    }

    .image-tile a {
      display: block;
      text-decoration: none;
      color: inherit;
    }

    .image-caption {
      display: none;
    }

    .image-empty {
      color: var(--muted);
      font-size: 0.9rem;
    }

    /* A-3: ã€Œé¸æŠç‡ã¨åå·®å€¤ã®æ¨ç§»ã€å†…ã«ç”»åƒã‚’æ¨ªä¸¦ã³è¡¨ç¤º */
    .a3-trend-wrap {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .a3-trend-text {
      flex: 1;
      min-width: 0;
    }

    .a3-trend-image {
      flex: 0 0 320px;
      max-width: 320px;
    }

    .a3-trend-image img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
    }
    .a3-trend-image.is-empty {
      display: none;
    }
    .a3-trend-image.is-loading {
      opacity: 0.65;
    }

    @media (max-width: 900px) {
      .a3-trend-wrap {
        flex-direction: column;
      }

      .a3-trend-image {
        flex: 1 1 auto;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">å›½è©¦åˆ†æ</div>
    <div id="currentViewLabel" class="view-label">ãƒ›ãƒ¼ãƒ </div>
  </header>
  <nav class="top-nav">
    <button id="navA1" class="active">ãƒ›ãƒ¼ãƒ </button>
    <button id="navA2">RBCã‹ã‚‰æ¤œç´¢</button>
    <button id="navA4">å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰æ¤œç´¢</button>
  </nav>

  <div class="app-shell">
    <main class="main">
      <!-- A-1 ãƒ›ãƒ¼ãƒ ç”»é¢ -->
      <div id="viewA1" class="view active">
        <div class="card">
          <h2 class="view-title">ãƒ›ãƒ¼ãƒ </h2>
          <p class="subtitle">å›½è©¦ã®RBCåˆ¥åˆ†æãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
        </div>
        <div class="card">
          <div class="section-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button id="btnA1ToA2" class="primary" type="button">RBCã‹ã‚‰æ¤œç´¢ã¸</button>
            <button id="btnA1ToA4" class="secondary" type="button">å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰æ¤œç´¢ã¸</button>
          </div>
        </div>
      </div>

      <!-- A-2 RBCã‹ã‚‰æ¤œç´¢ç”»é¢ -->
      <div id="viewA2" class="view">
        <div class="view-header">
          <h2 class="view-title">RBCã‹ã‚‰æ¤œç´¢</h2>
          <p class="subtitle">ç« ã¨RBCã‚’é¸ã‚“ã§å¯¾è±¡å•é¡Œã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
        </div>

        <div class="a2-grid">
          <!-- ä¸Šï¼šæ¤œç´¢/ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ¨ªé•·ï¼‰ -->
          <div class="card">
            <div class="a2-filters">
              <div class="a2-filter-col">
                <div class="section-title">ç« </div>
                <div id="chapterTabs" class="tabs"></div>
              </div>

              <div class="a2-filter-col">
                <div class="section-title">RBC</div>
                <div style="margin-bottom: 8px;">
                  <input
                    id="rbcFilterInput"
                    type="text"
                    placeholder="ã“ã®ç« ã®RBCã‚’çµã‚Šè¾¼ã¿ï¼ˆä¾‹: é…¸ç´ , ä¸Šçš® ãªã©ï¼‰"
                  />
                </div>
                <div id="rbcTabs" class="tabs"></div>
              </div>
            </div>
          </div>

          <!-- ä¸­ï¼šã‚µãƒãƒªãƒ¼ -->
          <div class="card compact">
            <div class="section-title">ã‚µãƒãƒªãƒ¼</div>
            <div id="a2Summary" class="summary-box is-hidden">
              <div class="summary-item">
                <div class="section-title">ç« </div>
                <div id="a2ChapterMiniTabs" class="mini-tabs"></div>
                <div class="summary-value is-hidden" id="a2Chapter"></div>
              </div>

              <div class="summary-item">
                <div class="section-title">RBC</div>
                <div class="summary-value" id="a2RbcName"></div>
              </div>

              <div class="summary-item">
                <div class="section-title">åˆè¨ˆå•é¡Œæ•°</div>
                <div class="summary-value">
                  <span id="a2TotalAll"></span>å•ï¼ˆ<span id="a2TotalAllRank"></span>ä½ï¼‰
                </div>
              </div>

              <div class="summary-item">
                <div class="section-title">å†…è¨³</div>
                <div class="summary-value">
                  å¿…ä¿® <span id="a2Kishu"></span>å•<br />
                  ä¸€èˆ¬ <span id="a2Ippan"></span>å•<br />
                  çŠ¶æ³ <span id="a2Jokyo"></span>å•
                </div>
              </div>

              <div class="summary-item wide">
                <div class="section-title">å‡ºé¡Œå‚¾å‘</div>
                <div class="summary-value" id="a2Analysis" style="white-space: pre-wrap;"></div>
              </div>
            </div>
            </div>

          <!-- ä¸‹ï¼šæ¤œç´¢çµæœ -->
          <div class="card">
            <div class="section-title">æ¤œç´¢çµæœ</div>

            <div class="search-box">
              <label for="rbcInput">RBCåã§æ¤œç´¢</label>
              <input id="rbcInput" type="text" placeholder="ä¾‹: ç´°èƒç·è«–ã€ä¸Šçš®çµ„ç¹” ãªã©" />
              <button id="searchButton" class="primary">æ¤œç´¢</button>
              <button id="clearButton" class="secondary">ã‚¯ãƒªã‚¢</button>

              <div id="resultCount" class="result-count"></div>
            </div>

            <div id="results"></div>
          </div>
        </div>
      </div>

      <!-- A-3 å•é¡Œè©³ç´°ç”»é¢ -->
      <div id="viewA3" class="view">
        <div class="view-header">
          <h2 class="view-title">å•é¡Œè©³ç´°</h2>
          <p class="subtitle">å•é¡Œã®è©³ç´°ã¨è§£èª¬ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
        </div>

        <div class="card a3-header">
          <div id="a3Code">å•é¡Œç•ªå·</div>
          <div class="a3-actions">
            <button id="a3EditToggleButton" class="primary">ç·¨é›†</button>
            <button id="btnA3BackToA2" class="secondary" type="button">å‰ã®æ¤œç´¢ã¸</button>
            <button id="btnA3BackToA4" class="secondary" type="button" style="display:none;">å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button>
          </div>
        </div>

        <div class="card section-card">
          <div class="section-title">å•é¡Œæ–‡</div>
          <div id="a3Body"></div>
          <div id="a3Images" style="margin-top: 12px;"></div>
        </div>

        <div class="card section-card">
          <div class="a3-choice-box">
            <div class="a3-choice-left">
              <div class="section-title">é¸æŠè‚¢</div>
              <ol id="a3Choices" style="padding-left: 1.5rem;"></ol>
            </div>

            <div class="a3-choice-right">
              <div class="a3-choice-right-top">
                <div class="section-title">è§£ç­”</div>
                <div id="a3Answer"></div>
              </div>

              <div class="a3-choice-right-bottom">
                <div class="section-title">æ­£ç­”ç‡</div>
                <div id="a3Rate"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card section-card">
          <div class="section-title">è§£èª¬</div>
          <div id="a3Comment"></div>
        </div>

        <div id="a3EditSection" class="card" style="display:none;">
          <div class="section-title">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</div>

          <div style="margin-bottom: 12px;">
            <label for="a3EditBody">å•é¡Œæ–‡ï¼ˆç·¨é›†ï¼‰</label>
            <textarea id="a3EditBody"></textarea>
          </div>

          <div style="margin-bottom: 12px;">
            <label for="a3EditChoice1">é¸æŠè‚¢1</label>
            <input id="a3EditChoice1" type="text" />
          </div>
          <div style="margin-bottom: 12px;">
            <label for="a3EditChoice2">é¸æŠè‚¢2</label>
            <input id="a3EditChoice2" type="text" />
          </div>
          <div style="margin-bottom: 12px;">
            <label for="a3EditChoice3">é¸æŠè‚¢3</label>
            <input id="a3EditChoice3" type="text" />
          </div>
          <div style="margin-bottom: 12px;">
            <label for="a3EditChoice4">é¸æŠè‚¢4</label>
            <input id="a3EditChoice4" type="text" />
          </div>
          <div style="margin-bottom: 12px;">
            <label for="a3EditChoice5">é¸æŠè‚¢5</label>
            <input id="a3EditChoice5" type="text" />
          </div>

          <div style="margin-bottom: 12px;">
            <label for="a3EditComment">è§£èª¬ï¼ˆç·¨é›†ï¼‰</label>
            <textarea id="a3EditComment"></textarea>
          </div>

          <button id="a3SaveButton" class="primary">ä¿å­˜</button>
          <button id="a3CancelButton" class="secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>

      <!-- A-4 å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ -->
      <div id="viewA4" class="view">
        <div class="view-header">
          <h2 class="view-title">å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰æ¤œç´¢</h2>
          <p class="subtitle">å‡ºé¡Œæ•°ãŒå¤šã„RBCã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã—ã¾ã™ã€‚</p>
        </div>

        <div class="card">
          <div class="section-title">ç« </div>
          <div id="a4ChapterTabs" class="tabs"></div>

          <div style="height: 12px;"></div>

          <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:end;">
            <!-- select ã¯äº’æ›ç”¨ã«æ®‹ã™ï¼ˆCSSã§éè¡¨ç¤ºï¼‰ -->
            <div style="flex:1 1 200px;">
              <label for="a4ChapterSelect">ç« </label>
              <select id="a4ChapterSelect">
                <option value="">ã™ã¹ã¦</option>
              </select>
            </div>

            <div style="flex:1 1 200px;" class="is-hidden">
              <label for="a4BasisSelect">åŸºæº–</label>
              <select id="a4BasisSelect">
                <option value="totalScore">åˆè¨ˆç‚¹æ•°</option>
                <option value="totalAll">åˆè¨ˆå•é¡Œæ•°</option>
                <option value="totalKishu">å¿…ä¿®å•é¡Œæ•°</option>
                <option value="totalIppan">ä¸€èˆ¬å•é¡Œæ•°</option>
                <option value="totalJokyo">çŠ¶æ³å•é¡Œæ•°</option>
                <option value="totalOver70">æ­£ç­”ç‡70%ä»¥ä¸Šã®å•é¡Œæ•°</option>
              </select>
            </div>
          </div>

          <p class="subtitle" style="margin-top:8px;">
            â€» è¡¨ã®è¦‹å‡ºã—ï¼ˆåˆè¨ˆç‚¹æ•°ãƒ»åˆè¨ˆå•é¡Œæ•°ãƒ»å¿…ä¿®å•é¡Œæ•°ãƒ»ä¸€èˆ¬å•é¡Œæ•°ãƒ»çŠ¶æ³å•é¡Œæ•°ãƒ»æ­£ç­”ç‡70%ä»¥ä¸Šï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€åŸºæº–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚
          </p>
        </div>

        <div class="card compact">
          <div id="a4RankingCount" class="result-count"></div>
          <div id="a4RankingTable"></div>
        </div>

        <button id="btnA4BackToA1" class="secondary" type="button">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
      </div>
    </main>
  </div>

  <div id="toast" class="toast" aria-live="polite"></div>

  <!-- ğŸ“¦ JavaScript -->
  <script>
    // ============================
    // 0) ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆï¼ˆA-1ã€œA-4ï¼‰
    // ============================
    const viewA1 = document.getElementById("viewA1");
    const viewA2 = document.getElementById("viewA2");
    const viewA3 = document.getElementById("viewA3");
    const viewA4 = document.getElementById("viewA4");

    const navA1 = document.getElementById("navA1");
    const navA2 = document.getElementById("navA2");
    const navA4 = document.getElementById("navA4");
    const currentViewLabel = document.getElementById("currentViewLabel");
    const viewNameMap = {
      A1: "ãƒ›ãƒ¼ãƒ ",
      A2: "RBCã‹ã‚‰æ¤œç´¢",
      A3: "å•é¡Œè©³ç´°",
      A4: "å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°",
    };

    const toast = document.getElementById("toast");
    let toastTimer = null;
    function showToast(message) {
      if (!toast) return;
      toast.textContent = message;
      toast.classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toast.classList.remove("show");
      }, 1800);
    }

    function showView(name) {
      // view ã®è¡¨ç¤º/éè¡¨ç¤º
      [viewA1, viewA2, viewA3, viewA4].forEach((v) => v.classList.remove("active"));
      if (name === "A1") viewA1.classList.add("active");
      if (name === "A2") viewA2.classList.add("active");
      if (name === "A3") viewA3.classList.add("active");
      if (name === "A4") viewA4.classList.add("active");

      // ãƒŠãƒ“ã®çŠ¶æ…‹
      [navA1, navA2, navA4].forEach((b) => b.classList.remove("active"));
      if (name === "A1") navA1.classList.add("active");
      if (name === "A2") navA2.classList.add("active");
      if (name === "A4") navA4.classList.add("active");

      if (currentViewLabel) {
        currentViewLabel.textContent = viewNameMap[name] || name;
      }

      // A-3ã«é·ç§»ã—ãŸã¨ãã¯ãƒšãƒ¼ã‚¸å…ˆé ­ã¸ï¼ˆã‚¹ãƒãƒ›/PCä¸¡å¯¾å¿œï¼‰
      if (name === "A3") {
        // ã¾ãšãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ä¸Šã¸
        window.scrollTo({ top: 0, left: 0, behavior: "smooth" });
        // å¿µã®ãŸã‚ãƒ¡ã‚¤ãƒ³é ˜åŸŸã‚‚å…ˆé ­ã¸å¯„ã›ã‚‹
        const mainEl = document.querySelector("main.main");
        if (mainEl) mainEl.scrollTop = 0;
      }
    }
    // Expose navigation helpers for inline handlers (Cloudflare Pages / strict scopes safety)
    window.showView = showView;

    // ---- Home / detail / ranking navigation buttons (avoid inline onclick) ----
    function bindNavButton(id, targetView) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("click", (e) => {
        e.preventDefault();
        showView(targetView);
      });
    }

    bindNavButton("btnA1ToA2", "A2");
    bindNavButton("btnA1ToA4", "A4");
    bindNavButton("btnA3BackToA2", "A2");
    bindNavButton("btnA3BackToA4", "A4");
    bindNavButton("btnA4BackToA1", "A1");

    console.log("nav buttons bound", {
      btnA1ToA2: !!document.getElementById("btnA1ToA2"),
      btnA1ToA4: !!document.getElementById("btnA1ToA4"),
      btnA3BackToA2: !!document.getElementById("btnA3BackToA2"),
      btnA3BackToA4: !!document.getElementById("btnA3BackToA4"),
      btnA4BackToA1: !!document.getElementById("btnA4BackToA1"),
    });

    // ãƒŠãƒ“ãƒœã‚¿ãƒ³ã«ã‚‚ showView ã‚’ã¤ãªã
    navA1.addEventListener("click", () => showView("A1"));
    navA2.addEventListener("click", () => showView("A2"));
    navA4.addEventListener("click", () => showView("A4"));

    // ============================
    // 1) ãƒ‡ãƒ¼ã‚¿é…åˆ—
    // ============================
    const questions = []; // é …ç›®.csv ã®å•é¡Œãƒ‡ãƒ¼ã‚¿
    const rbcItems = [];  // rbc_small.csv ã®å†…å®¹
    const questionStats = []; // æ­£ç­”ç‡.csv ã®ãƒ‡ãƒ¼ã‚¿
    const explanations = []; // explanations.csv ã®å†…å®¹
    const rbcAnalyses = []; // rbc_analysis.csv ã®å†…å®¹
    const rbcAnalysisById = new Map();
    const rbcAnalysisByName = new Map();

    // ============================
    // 1.5) ç·¨é›†å·®åˆ†ï¼ˆpatchï¼‰
    // ============================
    // key: question_code
    // value: { body?, choices?, comment? }
    let patch = {};

    // ============================
    // 1.6) D1(Pages Functions) ã‹ã‚‰ç·¨é›†å·®åˆ†ã‚’å–å¾—/ä¿å­˜
    // ============================
    async function fetchPatchFromServer(code) {
      const c = String(code || "").trim();
      if (!c) return null;
      try {
        const res = await fetch(`/api/patch?code=${encodeURIComponent(c)}`, { cache: "no-store" });
        if (!res.ok) return null;
        const data = await res.json();
        return data && data.patch ? data.patch : null;
      } catch (e) {
        console.warn("fetchPatchFromServer failed", e);
        return null;
      }
    }

    function mergePatchIntoQuestion(q, p) {
      if (!q || !p) return;
      if (typeof p.body === "string") q.body = p.body;
      if (Array.isArray(p.choices)) {
        const arr = p.choices.slice(0, 5);
        while (arr.length < 5) arr.push("");
        q.choices = arr;
      }
      if (typeof p.comment === "string") q.comment = p.comment;
    }

    async function applyPatchToQuestion(code) {
      const c = String(code || "").trim();
      if (!c) return;

      // ãƒ­ãƒ¼ã‚«ãƒ«patchãŒã‚ã‚Œã°å³æ™‚åæ˜ 
      const local = patch[c];
      const qLocal = questions.find((item) => item.code === c);
      if (qLocal && local) mergePatchIntoQuestion(qLocal, local);

      // ã‚µãƒ¼ãƒï¼ˆD1ï¼‰ã‹ã‚‰å–å¾—ã—ã¦æœ€æ–°ã‚’ä¸Šæ›¸ã
      const serverPatch = await fetchPatchFromServer(c);
      if (!serverPatch) return;

      patch[c] = serverPatch; // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      const q = questions.find((item) => item.code === c);
      if (q) mergePatchIntoQuestion(q, serverPatch);
    }

    async function savePatchToServer(question_code, patchObj) {
      const code = String(question_code || "").trim();
      if (!code) throw new Error("missing question_code");
      if (!patchObj || typeof patchObj !== "object") throw new Error("missing patch");

      const res = await fetch("/api/patch", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          question_code: code,
          actor: "", // ã„ã£ãŸã‚“ç©ºã§OK
          source: "ui",
          patch: patchObj,
        }),
      });

      if (!res.ok) {
        const t = await res.text().catch(() => "");
        throw new Error(`save failed: ${res.status} ${t}`);
      }
      return true;
    }

    // ============================
    // 2) HTMLè¦ç´ ã‚’ã¤ã‹ã‚€ï¼ˆA-2ï¼‰
    // ============================
    const rbcInput = document.getElementById("rbcInput");
    const searchButton = document.getElementById("searchButton");
    const clearButton = document.getElementById("clearButton");
    const resultsDiv = document.getElementById("results");
    const resultCount = document.getElementById("resultCount");
    // æ‰‹å‹•CSVèª­ã¿è¾¼ã¿ã¯å»ƒæ­¢

    // A-2 ã‚µãƒãƒªãƒ¼éƒ¨
    const a2Summary = document.getElementById("a2Summary");
    const a2Chapter = document.getElementById("a2Chapter");
    const a2ChapterMiniTabs = document.getElementById("a2ChapterMiniTabs");
    const a2RbcName = document.getElementById("a2RbcName");
    const a2Analysis = document.getElementById("a2Analysis");
    const a2TotalAll = document.getElementById("a2TotalAll");
    const a2TotalAllRank = document.getElementById("a2TotalAllRank");
    const a2Kishu = document.getElementById("a2Kishu");
    const a2Ippan = document.getElementById("a2Ippan");
    const a2Jokyo = document.getElementById("a2Jokyo");

    // A-3 å•é¡Œè©³ç´°éƒ¨
    const a3Code = document.getElementById("a3Code");
    const a3Body = document.getElementById("a3Body");
    const a3Images = document.getElementById("a3Images");
    async function resolveAllExisting(urls) {
      const list = Array.isArray(urls) ? urls.filter(Boolean) : [];
      const ok = [];
      for (const url of list) {
        try {
          const r = await fetch(url, { method: "HEAD", cache: "no-store" });
          if (r.ok) {
            ok.push(url);
            continue;
          }
        } catch (e) {
          // ignore
        }
        try {
          const r2 = await fetch(url, { method: "GET", cache: "no-store" });
          if (r2.ok) ok.push(url);
        } catch (e2) {
          // ignore
        }
      }
      return ok;
    }

    function buildQuestionImageCandidates(code, maxCount = 30, extraFilenames = []) {
      const base = String(code || "").trim();
      if (!base) return [];
      const cands = [];
      const seen = new Set();
      const pushUnique = (url) => {
        if (!url || seen.has(url)) return;
        seen.add(url);
        cands.push(url);
      };
      const normalizeExtra = (value) => {
        let v = String(value ?? "").trim();
        if (!v) return "";
        if ((v.startsWith('"') && v.endsWith('"')) || (v.startsWith("'") && v.endsWith("'"))) {
          v = v.slice(1, -1).trim();
        }
        v = v.replace(/\\/g, "/");
        let path = v;
        let suffix = "";
        const qIndex = v.indexOf("?");
        if (qIndex >= 0) {
          path = v.slice(0, qIndex);
          suffix = v.slice(qIndex);
        }
        if (!/\.[A-Za-z0-9]+$/.test(path)) {
          path = `${path}.png`;
        }
        let full = `${path}${suffix}`;
        if (!/^https?:\/\//i.test(full) && !full.startsWith("/") && !full.startsWith("data/")) {
          full = `data/images/${full}`;
        }
        return full;
      };

      const extras = Array.isArray(extraFilenames) ? extraFilenames : [extraFilenames];
      extras
        .flatMap((item) => String(item ?? "").split(/[\s,;]+/).filter(Boolean))
        .forEach((item) => {
          pushUnique(normalizeExtra(item));
        });
      for (let i = 1; i <= maxCount; i++) {
        pushUnique(`data/images/${base}-${i}.png`);
      }
      return cands;
    }

    function buildTrendImageCandidates(questionCode) {
      // è¦ä»¶: question_code ã¨å®Œå…¨ä¸€è‡´ã™ã‚‹ç”»åƒã ã‘ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆP/Aã¯åˆ¥å•é¡Œãªã®ã§å¤‰æ›ã—ãªã„ï¼‰
      const code = String(questionCode ?? "").trim();
      if (!code) return [];

      // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã¯ <question_code>.png ã‚’å‰æ
      const filename = `${code}.png`;

      // Pages ã®é…ä¿¡ãƒ‘ã‚¹æºã‚Œã«å‚™ãˆã¦å€™è£œã‚’è¤‡æ•°æŒã¤ãŒã€æœ€å„ªå…ˆã¯ data/images_rbc_analysis
      return [
        `data/images_rbc_analysis/${filename}`,
        `/data/images_rbc_analysis/${filename}`,
        `images_rbc_analysis/${filename}`,
        `/images_rbc_analysis/${filename}`,
      ];
    }
    async function renderQuestionImagesByCode(code, explanation) {
      if (!a3Images) return;
      a3Images.innerHTML = "";

      const extraNames = [];
      if (explanation && typeof explanation === "object") {
        const extraKeys = ["image_id", "imageId", "imageid", "ç”»åƒ"];
        extraKeys.forEach((key) => {
          if (explanation[key] != null) {
            extraNames.push(String(explanation[key]));
          }
        });
      }
      const candidates = buildQuestionImageCandidates(code, 30, extraNames);

      // Cloudflare Pagesã§ã¯ fetch(HEAD/GET) ã ã¨ 404 ãƒšãƒ¼ã‚¸ã‚’æ‹¾ã£ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€
      // å®Ÿéš›ã« Image ã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã§ããŸã‚‚ã®ã ã‘ã‚’ã€Œå­˜åœ¨ã™ã‚‹ç”»åƒã€ã¨ã¿ãªã™ã€‚
      const loadable = await (async () => {
        const ok = [];

        const tryLoad = (url) =>
          new Promise((resolve) => {
            const img = new Image();
            img.decoding = "async";
            img.onload = () => resolve(url);
            img.onerror = () => resolve("");
            // cache-bustï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ç›´å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å¼·ãã™ã‚‹ï¼‰
            const u = url.includes("?") ? `${url}&v=${Date.now()}` : `${url}?v=${Date.now()}`;
            img.src = u;
          });

        // é€æ¬¡ã§ååˆ†ï¼ˆæœ€å¤§30æšï¼‰
        for (const url of candidates) {
          const hit = await tryLoad(url);
          if (hit) {
            // tryLoad ã§ä»˜ã‘ãŸ ?v=... ã‚’å¤–ã—ã¦è¡¨ç¤ºç”¨URLã¯ç´ ã®ãƒ‘ã‚¹ã«ã™ã‚‹
            ok.push(url);
          }
        }

        return ok;
      })();

      if (!loadable.length) {
        a3Images.innerHTML = `<div class="image-empty">å‚è€ƒç”»åƒã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      const tiles = loadable
        .map((url) => {
          const name = url.split("/").pop() || url;
          return `
            <div class="image-tile">
              <a href="${url}" target="_blank" rel="noopener">
                <img class="qimg" src="${url}" alt="" loading="lazy" />
              </a>
            </div>
          `;
        })
        .join("");

      a3Images.innerHTML = `<div class="section-title" style="margin:0 0 6px;">å‚è€ƒç”»åƒ</div><div class="image-gallery">${tiles}</div>`;

      // å¿µã®ãŸã‚ã€è¡¨ç¤ºå¾Œã«å£Šã‚ŒãŸç”»åƒãŒå‡ºãŸå ´åˆã¯ã‚¿ã‚¤ãƒ«ã”ã¨æ¶ˆã™
      Array.from(a3Images.querySelectorAll("img.qimg")).forEach((img) => {
        img.addEventListener("error", () => {
          const tile = img.closest(".image-tile");
          if (tile) tile.remove();
          const remain = a3Images.querySelectorAll("img.qimg").length;
          if (remain === 0) {
            a3Images.innerHTML = `<div class="image-empty">å‚è€ƒç”»åƒã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
          }
        });
      });
    }
    const a3Choices = document.getElementById("a3Choices");
    const a3Answer = document.getElementById("a3Answer");
    const a3Rate = document.getElementById("a3Rate");
    const a3Comment = document.getElementById("a3Comment");

    // A-3 ç·¨é›†è¦ç´ 
    const a3EditToggleButton = document.getElementById("a3EditToggleButton");
    const a3EditSection = document.getElementById("a3EditSection");
    const a3EditBody = document.getElementById("a3EditBody");
    const a3EditChoice1 = document.getElementById("a3EditChoice1");
    const a3EditChoice2 = document.getElementById("a3EditChoice2");
    const a3EditChoice3 = document.getElementById("a3EditChoice3");
    const a3EditChoice4 = document.getElementById("a3EditChoice4");
    const a3EditChoice5 = document.getElementById("a3EditChoice5");
    const a3EditComment = document.getElementById("a3EditComment");
    const a3SaveButton = document.getElementById("a3SaveButton");
    const a3CancelButton = document.getElementById("a3CancelButton");

    // A-2 ç«  / RBC ã‚¿ãƒ–
    const chapterTabs = document.getElementById("chapterTabs");
    const rbcTabs = document.getElementById("rbcTabs");
    const rbcFilterInput = document.getElementById("rbcFilterInput");
    // A-4 ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨è¦ç´ 
    const a4ChapterTabs = document.getElementById("a4ChapterTabs");
    const a4ChapterSelect = document.getElementById("a4ChapterSelect"); // äº’æ›ç”¨ï¼ˆéè¡¨ç¤ºï¼‰
    const a4BasisSelect = document.getElementById("a4BasisSelect");
    const a4RankingTable = document.getElementById("a4RankingTable");
    const a4RankingCount = document.getElementById("a4RankingCount");
    // çŠ¶æ…‹ç®¡ç†ç”¨
    let currentChapter = null;
    let currentRbc = null;
    let currentRbcFilter = "";
    let currentQuestionCode = null;
    let allChaptersForA2 = [];
    // A-3 ã‚’ã©ã“ã‹ã‚‰é–‹ã„ãŸã‹ï¼ˆA2 or A4ï¼‰
    let lastA3Origin = "A2";
    let currentA4Chapter = "";
    // A-4ã®åˆæœŸè¡¨ç¤ºã¯ã€Œåˆè¨ˆç‚¹æ•°ã€åŸºæº–
    let currentA4Basis = "totalScore";

    // ============================
    // 3) æ¤œç´¢ãƒœã‚¿ãƒ³ï¼ˆA-2ï¼‰
    // ============================
    searchButton.addEventListener("click", () => {
      const keyword = rbcInput.value.trim();
      if (keyword === "") {
        alert("RBCåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const lowerKeyword = keyword.toLowerCase();

      // A-2 ä¸‹åŠåˆ†ï¼šé …ç›®.csv ã‹ã‚‰è©²å½“RBCã®å•é¡Œãƒªã‚¹ãƒˆã‚’å–å¾—
      const qs = questions.filter(
        (q) => q.rbcName && q.rbcName.toLowerCase().includes(lowerKeyword)
      );

      // A-2 ä¸Šéƒ¨ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      if (qs.length > 0) {
        const qfirst = qs[0];
        a2Chapter.textContent = qfirst.chapter || "";
        renderA2ChapterMiniTabs(allChaptersForA2, qfirst.chapter);
        a2RbcName.textContent = qfirst.rbcName || "";

        // å‡ºé¡Œå‚¾å‘ï¼ˆrbc_analysis.csvï¼‰
        if (a2Analysis) {
          const byId = Number.isFinite(qfirst.rbcId)
            ? rbcAnalysisById.get(qfirst.rbcId)
            : null;
          const byName = rbcAnalysisByName.get(
            String(qfirst.rbcName || "").trim().toLowerCase()
          );
          a2Analysis.textContent = byId || byName || "ï¼ˆå‡ºé¡Œå‚¾å‘ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";
        }

        // å•é¡Œæ•°ï¼ˆrbc_small.csv ã‚’å„ªå…ˆï¼‰
        const rbcMaster = rbcItems.find(
          (it) =>
            String(it.rbcName || "").trim() === String(qfirst.rbcName || "").trim() &&
            (!qfirst.chapter || String(it.chapter || "").trim() === String(qfirst.chapter || "").trim())
        ) || rbcItems.find(
          (it) => String(it.rbcName || "").trim() === String(qfirst.rbcName || "").trim()
        ) || null;

        const totalAll = rbcMaster ? (rbcMaster.totalAll ?? qs.length) : qs.length;

        if (totalAll === 0) {
          // å‡ºé¡Œãªã—ã®å ´åˆã®ç‰¹åˆ¥è¡¨ç¤º
          a2Analysis.textContent = "ã“ã®åˆ†é‡ã¯éå»10å¹´ã®å‡ºé¡ŒãŒã‚ã‚Šã¾ã›ã‚“";
          a2TotalAll.textContent = "0";
          a2TotalAllRank.textContent = "";
          a2Kishu.textContent = "0";
          a2Ippan.textContent = "0";
          a2Jokyo.textContent = "0";
        } else if (rbcMaster) {
          a2TotalAll.textContent = String(rbcMaster.totalAll ?? totalAll);
          a2TotalAllRank.textContent = rbcMaster.totalAllRank != null ? String(rbcMaster.totalAllRank) : "";
          a2Kishu.textContent = String(rbcMaster.totalKishu ?? 0);
          a2Ippan.textContent = String(rbcMaster.totalIppan ?? 0);
          a2Jokyo.textContent = String(rbcMaster.totalJokyo ?? 0);
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          a2TotalAll.textContent = String(totalAll);
          a2TotalAllRank.textContent = "";
          a2Kishu.textContent = "";
          a2Ippan.textContent = "";
          a2Jokyo.textContent = "";
        }

        a2Summary.classList.remove("is-hidden");
      } else {
        // å•é¡Œè‡ªä½“ãŒ0ä»¶ã®å ´åˆ
        a2Chapter.textContent = "";
        setActiveMiniTab("");
        a2RbcName.textContent = "";
        // ã‚¿ãƒ–/æ¤œç´¢å…¥åŠ›ã§é¸ã‚“ã RBCåã¯æ®‹ã™ï¼ˆ0ä»¶ã§ã‚‚åˆ†é‡ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«ï¼‰
        a2RbcName.textContent = keyword;
        if (a2Analysis) {
          a2Analysis.textContent = "ã“ã®åˆ†é‡ã¯éå»10å¹´ã®å‡ºé¡ŒãŒã‚ã‚Šã¾ã›ã‚“";
        }
        a2TotalAll.textContent = "0";
        a2TotalAllRank.textContent = "";
        a2Kishu.textContent = "0";
        a2Ippan.textContent = "0";
        a2Jokyo.textContent = "0";
        a2Summary.classList.remove("is-hidden");
      }

      renderQuestionList(qs, keyword);
      showView("A2"); // A-1 ã‹ã‚‰æ¤œç´¢ã—ã¦ããŸå ´åˆã§ã‚‚ A-2 ã‚’è¡¨ç¤ºã™ã‚‹
    });

    // Enterã‚­ãƒ¼ã§ã‚‚æ¤œç´¢
    rbcInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        searchButton.click();
      }
    });

    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    clearButton.addEventListener("click", () => {
      rbcInput.value = "";
      resultCount.textContent = "";
      resultsDiv.innerHTML = "";
      a2Summary.classList.add("is-hidden");
      rbcInput.focus();
    });

    // ============================
    // 3.4) CSV/TSV ãƒ‘ãƒ¼ã‚µï¼ˆå¼•ç”¨ç¬¦å¯¾å¿œï¼‰
    // ============================
    function detectDelimiter(text) {
      // å…ˆé ­è¡Œã ã‘è¦‹ã¦ã€ã‚¿ãƒ–ãŒå¤šã‘ã‚Œã°TSVæ‰±ã„
      const firstLine = (text || "").split(/\r?\n/)[0] || "";
      const tabCount = (firstLine.match(/\t/g) || []).length;
      const commaCount = (firstLine.match(/,/g) || []).length;
      return tabCount > commaCount ? "\t" : ",";
    }

    function parseDelimitedText(text, delimiter) {
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;

      const d = delimiter;
      const s = String(text || "");

      for (let i = 0; i < s.length; i++) {
        const ch = s[i];
        const next = s[i + 1];

        if (inQuotes) {
          if (ch === '"') {
            // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ "" ã‚’ " ã«ã™ã‚‹
            if (next === '"') {
              field += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            field += ch;
          }
          continue;
        }

        if (ch === '"') {
          inQuotes = true;
          continue;
        }

        if (ch === d) {
          row.push(field);
          field = "";
          continue;
        }

        if (ch === "\n") {
          row.push(field);
          field = "";
          rows.push(row);
          row = [];
          continue;
        }

        if (ch === "\r") {
          // \r\n ã® \r ã¯æ¨ã¦ã‚‹
          continue;
        }

        field += ch;
      }

      // last field
      row.push(field);
      // last rowï¼ˆæœ«å°¾æ”¹è¡Œã ã‘ã§ç©ºè¡Œã«ãªã£ã¦ã„ã‚‹å ´åˆã¯é™¤å¤–ï¼‰
      const allEmpty = row.every((v) => String(v || "").trim() === "");
      if (!allEmpty) rows.push(row);

      return rows;
    }

    function parseTable(text) {
      const delimiter = detectDelimiter(text);
      const rows = parseDelimitedText(text, delimiter);
      if (!rows.length) return { headers: [], rows: [] };
      const headers = rows[0].map((h) => String(h || "").trim());
      const bodyRows = rows.slice(1);
      return { headers, rows: bodyRows };
    }

    // ============================
    // 3.5) CSVè‡ªå‹•èª­ã¿è¾¼ã¿
    // ============================
    async function fetchCsvText(path) {
      const response = await fetch(path);
      if (!response.ok) {
        throw new Error(`CSV fetch failed: ${path}`);
      }
      return response.text();
    }

    async function loadAllCsvs() {
      try {
        const rbcText = await fetchCsvText("data/rbc_small.csv");
        loadRbcItemsFromCsv(rbcText);

        const rbcAnalysisText = await fetchCsvText("data/rbc_analysis.csv");
        loadRbcAnalysisFromCsv(rbcAnalysisText);

        const questionText = await fetchCsvText("data/questions.csv");
        loadQuestionsFromCsv(questionText);

        const statsText = await fetchCsvText("data/stats.csv");
        loadQuestionStatsFromCsv(statsText);

        const explanationsText = await fetchCsvText("data/explanations.csv");
        loadExplanationsFromCsv(explanationsText);

        console.log("all csv loaded");
      } catch (error) {
        console.error(error);
        alert("CSVã®è‡ªå‹•èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadAllCsvs();
    });

    // ============================
    // 4) RBCãƒã‚¹ã‚¿CSV ã®èª­ã¿è¾¼ã¿
    // ============================

    function loadRbcItemsFromCsv(csvText) {
      const table = parseTable(csvText);
      const headers = table.headers;
      const dataRows = table.rows;

      if (!headers.length || !dataRows.length) {
        alert("CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      const normalizeHeader = (value) => {
        return String(value || "")
          .replace(/^\uFEFF/, "") // remove BOM
          .replace(/\u3000/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      };

      const headerIndexMap = {};
      headers.forEach((h, idx) => {
        const normalized = normalizeHeader(h);
        if (!normalized) return;
        if (headerIndexMap[normalized] == null) {
          headerIndexMap[normalized] = idx;
        }
      });
      console.log("rbc_small headers:", headers.map((h) => normalizeHeader(h)));

      const findHeaderIndex = (candidates) => {
        for (const name of candidates) {
          const normalized = normalizeHeader(name);
          if (headerIndexMap[normalized] != null) {
            return headerIndexMap[normalized];
          }
        }
        return null;
      };

      const idx = {
        id: findHeaderIndex(["q_rbc_small_id", "rbc_id", "id"]),
        chapter: findHeaderIndex(["ç« ", "chapter", "Chapter"]),
        major: findHeaderIndex(["å¤§é …ç›®", "major"]),
        middle: findHeaderIndex(["ä¸­é …ç›®", "middle"]),
        rbcName: findHeaderIndex(["å°é …ç›®", "rbc_name", "rbcName", "RBC"]),
        order: findHeaderIndex(["è¡¨ç¤ºé †", "display_order", "order"]),
        valid: findHeaderIndex(["æœ‰åŠ¹", "valid"]),
        master: findHeaderIndex(["master", "ãƒã‚¹ã‚¿ãƒ¼"]),
        totalAll: findHeaderIndex(["éå»10å¹´ã™ã¹ã¦", "totalAll"]),
        totalAllRank: findHeaderIndex(["éå»10å¹´ã™ã¹ã¦åŒRBCrank", "totalAllRank"]),
        totalKishu: findHeaderIndex(["éå»10å¹´å¿…ä¿®", "totalKishu"]),
        totalKishuRank: findHeaderIndex(["éå»10å¹´å¿…ä¿®åŒRBCrank", "totalKishuRank"]),
        totalIppan: findHeaderIndex(["éå»10å¹´ä¸€èˆ¬", "totalIppan"]),
        totalIppanRank: findHeaderIndex(["éå»10å¹´ä¸€èˆ¬åŒRBCrank", "totalIppanRank"]),
        totalJokyo: findHeaderIndex(["éå»10å¹´çŠ¶æ³", "totalJokyo", "0"]),
        totalJokyoRank: findHeaderIndex(["éå»10å¹´çŠ¶æ³åŒRBCrank", "totalJokyoRank"]),
        totalOver70: findHeaderIndex(["éå»10å¹´70%ä»¥ä¸Š", "totalOver70", "éå»10å¹´70%ä»¥ä¸Šã®å•é¡Œæ•°"]),
        totalOver70Rank: findHeaderIndex(["éå»10å¹´70%ä»¥ä¸ŠåŒRBCrank", "totalOver70Rank"]),
      };

      const getValue = (cols, index) => {
        if (index == null) return "";
        return cols[index] != null ? String(cols[index]) : "";
      };

      const numberOrZero = (value) => {
        const num = Number(value);
        return Number.isFinite(num) ? num : 0;
      };

      const numberOrNull = (value) => {
        const num = Number(value);
        return Number.isFinite(num) ? num : null;
      };

      rbcItems.length = 0;

      for (const cols of dataRows) {
        const rbcName = getValue(cols, idx.rbcName);
        const item = {
          id: numberOrNull(getValue(cols, idx.id)),
          chapter: getValue(cols, idx.chapter).trim(),
          major: getValue(cols, idx.major),
          middle: getValue(cols, idx.middle),
          rbcName: (rbcName || "").trim(),

          order: numberOrNull(getValue(cols, idx.order)),
          valid: getValue(cols, idx.valid).trim() === "1",
          master: getValue(cols, idx.master).trim() === "1",

          totalAll: numberOrZero(getValue(cols, idx.totalAll)),
          totalAllRank: numberOrNull(getValue(cols, idx.totalAllRank)),

          totalKishu: numberOrZero(getValue(cols, idx.totalKishu)),
          totalKishuRank: numberOrNull(getValue(cols, idx.totalKishuRank)),

          totalIppan: numberOrZero(getValue(cols, idx.totalIppan)),
          totalIppanRank: numberOrNull(getValue(cols, idx.totalIppanRank)),

          totalJokyo: numberOrZero(getValue(cols, idx.totalJokyo)),
          totalJokyoRank: numberOrNull(getValue(cols, idx.totalJokyoRank)),

          totalOver70: numberOrZero(getValue(cols, idx.totalOver70)),
          totalOver70Rank: numberOrNull(getValue(cols, idx.totalOver70Rank)),
        };

        if (item.rbcName) {
          rbcItems.push(item);
        }
      }

      if (!rbcItems.length) {
        console.warn("No RBC rows loaded. Check rbc_small.csv header names / delimiter.");
      } else if (![...new Set(rbcItems.map((x) => (x.chapter || "").trim()).filter(Boolean))].length) {
        console.warn("RBC loaded but chapter column is empty. Check 'chapter' header mapping.");
      }
      console.log("RBCä»¶æ•°:", rbcItems.length);
      buildChapterTabs();
      buildA4Filters();
    }

    function loadRbcAnalysisFromCsv(csvText) {
      const table = parseTable(csvText);
      const headers = table.headers;
      const dataRows = table.rows;

      if (!headers.length || !dataRows.length) {
        console.warn("rbc_analysis.csv ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      const normalizeHeader = (value) => {
        return String(value || "")
          .replace(/\u3000/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      };

      const headerIndexMap = {};
      headers.forEach((h, idx) => {
        const normalized = normalizeHeader(h);
        if (!normalized) return;
        if (headerIndexMap[normalized] == null) {
          headerIndexMap[normalized] = idx;
        }
      });

      const findHeaderIndex = (candidates) => {
        for (const name of candidates) {
          const normalized = normalizeHeader(name);
          if (headerIndexMap[normalized] != null) {
            return headerIndexMap[normalized];
          }
        }
        return null;
      };

      const idxId = findHeaderIndex(["rbc_id", "rbcId", "id"]);
      const idxName = findHeaderIndex(["rbc_name", "rbcName", "RBC", "rbc"]);
      const idxAnalysis = findHeaderIndex(["analysis", "å‡ºé¡Œå‚¾å‘"]);

      const normalizeName = (value) => String(value || "").trim().toLowerCase();

      rbcAnalyses.length = 0;
      rbcAnalysisById.clear();
      rbcAnalysisByName.clear();

      for (const cols of dataRows) {
        const rbcIdRaw = idxId != null ? cols[idxId] : "";
        const rbcNameRaw = idxName != null ? cols[idxName] : "";
        const analysisRaw = idxAnalysis != null ? cols[idxAnalysis] : "";

        const rbcId = Number(rbcIdRaw);
        const rbcName = String(rbcNameRaw || "").trim();
        const analysis = String(analysisRaw || "");

        const row = { rbcId, rbcName, analysis };
        rbcAnalyses.push(row);

        if (Number.isFinite(rbcId) && !rbcAnalysisById.has(rbcId)) {
          rbcAnalysisById.set(rbcId, analysis);
        }

        const nameKey = normalizeName(rbcName);
        if (nameKey && !rbcAnalysisByName.has(nameKey)) {
          rbcAnalysisByName.set(nameKey, analysis);
        }
      }
    }

    function loadExplanationsFromCsv(csvText) {
      const table = parseTable(csvText);
      const headers = table.headers;
      const dataRows = table.rows;

      if (!headers.length || !dataRows.length) {
        alert("è§£èª¬CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      // question_code åˆ—ã‚’å„ªå…ˆ
      const headerIndexMap = {};
      headers.forEach((h, idx) => {
        if (h && headerIndexMap[h] == null) headerIndexMap[h] = idx;
      });

      const codeKeyCandidates = ["question_code", "code", "questionCode"];
      const codeKey = codeKeyCandidates.find((k) => headerIndexMap[k] != null) || headers[0];

      explanations.length = 0;

      for (const cols of dataRows) {
        const row = {};
        headers.forEach((h, idx) => {
          if (!h) return;
          row[h] = cols[idx] != null ? String(cols[idx]) : "";
        });

        const code = (row[codeKey] || "").trim();
        if (code) {
          row[codeKey] = code;
          explanations.push(row);
        }
      }

      console.log("è§£èª¬ä»¶æ•°:", explanations.length);

      const exMap = new Map(explanations.map((row) => [String(row[codeKey] || "").trim(), row]));

      // questions ã¸ join
      for (const q of questions) {
        const ex = exMap.get(String(q.code || "").trim());
        if (ex) {
          q.explanation = { ...ex };
        }
      }
    }

    // ============================
    // ç« ã‚¿ãƒ– / RBCã‚¿ãƒ–ã®æ§‹ç¯‰
    // ============================
    function setActiveMiniTab(activeChapter) {
      if (!a2ChapterMiniTabs) return;
      const active = String(activeChapter || "").trim();
      Array.from(a2ChapterMiniTabs.querySelectorAll("button")).forEach((btn) => {
        const ch = btn.getAttribute("data-chapter") || "";
        const isActive = active !== "" && ch === active;
        btn.classList.toggle("active", isActive);
        btn.setAttribute("aria-pressed", isActive ? "true" : "false");
      });
    }

    function renderA2ChapterMiniTabs(chapters, activeChapter) {
      if (!a2ChapterMiniTabs) return;
      const list = Array.isArray(chapters)
        ? chapters.map((ch) => String(ch || "").trim()).filter((ch) => ch !== "")
        : [];

      if (!list.length) {
        a2ChapterMiniTabs.innerHTML = "";
        return;
      }

      a2ChapterMiniTabs.innerHTML = list
        .map((ch) => {
          const label = ch.slice(0, 1);
          return `<button class="mini-tab-button" data-chapter="${ch}" aria-pressed="false">${label}</button>`;
        })
        .join("");

      Array.from(a2ChapterMiniTabs.querySelectorAll("button")).forEach((btn) => {
        btn.addEventListener("click", () => {
          const ch = btn.getAttribute("data-chapter") || "";
          if (!chapterTabs) return;
          const target = chapterTabs.querySelector(
            `button[data-chapter="${CSS.escape(ch)}"]`
          );
          if (target) target.click();
        });
      });

      setActiveMiniTab(activeChapter);
    }

    function buildChapterTabs() {
      if (!rbcItems.length || !chapterTabs) return;

      // ä¸€æ„ãªç« ä¸€è¦§ã‚’å–å¾—
      const chapters = [...new Set(
        rbcItems
          .map((item) => item.chapter)
          .filter((ch) => ch && ch.trim() !== "")
      )];

      chapters.sort();
      allChaptersForA2 = chapters.slice();
      renderA2ChapterMiniTabs(allChaptersForA2, currentChapter);

      chapterTabs.innerHTML = chapters
        .map(
          (ch) =>
            `<button class="tab-button" data-chapter="${ch}">${ch}</button>`
        )
        .join("");

      currentChapter = null;
      currentRbc = null;
      if (rbcTabs) {
        rbcTabs.innerHTML = "";
      }

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      Array.from(chapterTabs.querySelectorAll("button")).forEach((btn) => {
        btn.addEventListener("click", () => {
          currentChapter = btn.getAttribute("data-chapter");

          // è¦‹ãŸç›®ã® active åˆ‡ã‚Šæ›¿ãˆ
          chapterTabs
            .querySelectorAll("button")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // RBCãƒ•ã‚£ãƒ«ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
          currentRbcFilter = "";
          if (rbcFilterInput) {
            rbcFilterInput.value = "";
          }

          buildRbcTabs();
          renderA2ChapterMiniTabs(allChaptersForA2, currentChapter);
        });
      });
    }

    function buildRbcTabs() {
      if (!currentChapter || !rbcTabs) {
        if (rbcTabs) rbcTabs.innerHTML = "";
        return;
      }

      // ãƒ•ã‚£ãƒ«ã‚¿å…¥åŠ›å€¤ã§RBCåã‚’çµã‚Šè¾¼ã‚€
      const lowerFilter = currentRbcFilter
        ? currentRbcFilter.trim().toLowerCase()
        : "";

      // ãƒ•ã‚£ãƒ«ã‚¿ãŒç©ºã®ã¨ãã¯ã‚¿ãƒ–ã‚’è¡¨ç¤ºã—ãªã„
      if (!lowerFilter) {
        rbcTabs.innerHTML = "";
        currentRbc = null;
        return;
      }

      const rbcs = rbcItems
        .filter((item) => item.chapter === currentChapter)
        .map((item) => item.rbcName)
        .filter((name) => {
          if (!name) return false;
          const trimmed = name.trim();
          if (!trimmed) return false;
          return trimmed.toLowerCase().includes(lowerFilter);
        });

      const uniqueRbcs = [...new Set(rbcs)];
      uniqueRbcs.sort();

      rbcTabs.innerHTML = uniqueRbcs
        .map(
          (name) =>
            `<button class="tab-button" data-rbc="${name}">${name}</button>`
        )
        .join("");

      currentRbc = null;

      // ã‚¯ãƒªãƒƒã‚¯ã§RBCã‚’é¸æŠã—ã€æ—¢å­˜ã®æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
      Array.from(rbcTabs.querySelectorAll("button")).forEach((btn) => {
        btn.addEventListener("click", () => {
          currentRbc = btn.getAttribute("data-rbc");

          rbcTabs
            .querySelectorAll("button")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // æ—¢å­˜ã®æ¤œç´¢å‡¦ç†ã‚’å†åˆ©ç”¨
          if (rbcInput) {
            rbcInput.value = currentRbc;
            searchButton.click();
          }
        });
      });
    }

    // RBCåãƒ•ã‚£ãƒ«ã‚¿å…¥åŠ›: ã‚¿ã‚¤ãƒ—ã™ã‚‹ãŸã³ã«ã‚¿ãƒ–ã‚’çµã‚Šè¾¼ã¿
    if (rbcFilterInput) {
      rbcFilterInput.addEventListener("input", () => {
        currentRbcFilter = rbcFilterInput.value || "";
        buildRbcTabs();
      });
    }

    // ============================
    // A-4: ç« ãƒ»åŸºæº–ã®ãƒ•ã‚£ãƒ«ã‚¿ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨
    // ============================
    // ---- A-4 åˆè¨ˆç‚¹æ•°ç®—å‡ºãƒ»åŸºæº–å€¤å–å¾— ----
    function calcTotalScore(item) {
      const kishu = Number(item?.totalKishu || 0);
      const ippan = Number(item?.totalIppan || 0);
      const jokyo = Number(item?.totalJokyo || 0);
      return kishu + ippan + (jokyo * 2);
    }

    function getA4Metric(item, key) {
      if (key === "totalScore") return calcTotalScore(item);
      return Number(item?.[key] || 0);
    }

    function buildA4Filters() {
      if (!rbcItems.length) return;

      // ç« ä¸€è¦§
      const chapters = [...new Set(
        rbcItems
          .map((item) => item.chapter)
          .filter((ch) => ch && ch.trim() !== "")
      )].sort();

      // äº’æ›ç”¨ select ã®ä¸­èº«ã‚‚æ§‹ç¯‰ï¼ˆéè¡¨ç¤ºã ãŒå€¤åŒæœŸã«ä½¿ã†ï¼‰
      if (a4ChapterSelect) {
        a4ChapterSelect.innerHTML =
          '<option value="">ã™ã¹ã¦</option>' +
          chapters.map((ch) => `<option value="${ch}">${ch}</option>`).join("");
      }

      // ã‚¿ãƒ–UIã‚’æ§‹ç¯‰
      if (a4ChapterTabs) {
        const tabsHtml = [
          `<button class="tab-button" data-chapter="" aria-pressed="false">ã™ã¹ã¦</button>`,
          ...chapters.map((ch) => `<button class="tab-button" data-chapter="${ch}" aria-pressed="false">${ch}</button>`),
        ].join("");

        a4ChapterTabs.innerHTML = tabsHtml;

        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        Array.from(a4ChapterTabs.querySelectorAll("button")).forEach((btn) => {
          btn.addEventListener("click", () => {
            currentA4Chapter = btn.getAttribute("data-chapter") || "";

            // active è¡¨ç¤º
            a4ChapterTabs
              .querySelectorAll("button")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            // select ã¨åŒæœŸï¼ˆå¿µã®ãŸã‚ï¼‰
            if (a4ChapterSelect) a4ChapterSelect.value = currentA4Chapter;

            renderA4RankingTable();
          });
        });
      }

      // åˆæœŸå€¤
      currentA4Chapter = "";
      // åŸºæº–ã¯è¡¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆselectã¯äº’æ›ç”¨ï¼‰
      currentA4Basis = "totalScore";
      if (a4BasisSelect) a4BasisSelect.value = currentA4Basis;

      // äº’æ›ç”¨ select ã‹ã‚‰ã®å¤‰æ›´ã‚‚æ‹¾ã†ï¼ˆå°†æ¥ã®ãŸã‚ï¼‰
      if (a4ChapterSelect) {
        a4ChapterSelect.addEventListener("change", () => {
          currentA4Chapter = a4ChapterSelect.value;
          // ã‚¿ãƒ–ã® active åŒæœŸ
          if (a4ChapterTabs) {
            Array.from(a4ChapterTabs.querySelectorAll("button")).forEach((b) => {
              const ch = b.getAttribute("data-chapter") || "";
              b.classList.toggle("active", ch === currentA4Chapter);
            });
          }
          renderA4RankingTable();
        });
      }

      // åŸºæº–å¤‰æ›´ã¯è¡¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§è¡Œã†ï¼ˆselectã¯äº’æ›ç”¨ï¼‰
      if (a4BasisSelect) {
        a4BasisSelect.addEventListener("change", () => {
          currentA4Basis = a4BasisSelect.value || "totalScore";
          renderA4RankingTable();
        });
      }

      // ã‚¿ãƒ–UIã®åˆæœŸ active ã‚’ã€Œã™ã¹ã¦ã€ã«
      if (a4ChapterTabs) {
        const first = a4ChapterTabs.querySelector('button[data-chapter=""]');
        if (first) first.classList.add("active");
      }

      // åˆå›æç”»
      renderA4RankingTable();
    }

    function renderA4RankingTable() {
      if (!a4RankingTable) return;

      let list = rbcItems.slice();

      // ç« ã§ãƒ•ã‚£ãƒ«ã‚¿
      if (currentA4Chapter) {
        list = list.filter((item) => item.chapter === currentA4Chapter);
      }

      // ã‚½ãƒ¼ãƒˆç”¨ã®ã‚¹ã‚³ã‚¢ã‚’æ±ºã‚ã‚‹
      const key = currentA4Basis || "totalScore";

      list = list
        .sort((a, b) => {
          const av = getA4Metric(a, key);
          const bv = getA4Metric(b, key);
          if (bv !== av) return bv - av; // é™é †
          // ã‚¹ã‚³ã‚¢ãŒåŒã˜ã¨ãã¯RBCåã§æ˜‡é †
          return (a.rbcName || "").localeCompare(b.rbcName || "");
        });

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒç©ºã®å ´åˆ
      if (!list.length) {
        a4RankingTable.innerHTML =
          '<p class="no-result">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ã¨ãªã‚‹RBCãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        if (a4RankingCount) a4RankingCount.textContent = "";
        return;
      }

      if (a4RankingCount) {
        a4RankingCount.textContent = `${list.length}ä»¶ã®RBCãŒã‚ã‚Šã¾ã™ï¼ˆè¡¨ã®è¦‹å‡ºã—ã‚¯ãƒªãƒƒã‚¯ã§åŸºæº–ã‚’åˆ‡ã‚Šæ›¿ãˆï¼‰`;
      }

      const rowsHtml = list
        .map((item, index) => {
          const rank = index + 1;
          return `
            <tr onclick="goToRbcFromA4('${item.rbcName}')" style="cursor:pointer;">
              <td>${rank}</td>
              <td>${item.rbcName}</td>
              <td>${calcTotalScore(item) || 0}</td>
              <td>${item.totalAll || 0}</td>
              <td>${item.totalKishu || 0}</td>
              <td>${item.totalIppan || 0}</td>
              <td>${item.totalJokyo || 0}</td>
              <td>${item.totalOver70 || 0}</td>
            </tr>
          `;
        })
        .join("");

      const tableHtml = `
        <table id="a4Table">
          <thead>
            <tr>
              <th>é †ä½</th>
              <th>RBC</th>
              <th class="a4-sortable" data-basis="totalScore">åˆè¨ˆç‚¹æ•°</th>
              <th class="a4-sortable" data-basis="totalAll">åˆè¨ˆå•é¡Œæ•°</th>
              <th class="a4-sortable" data-basis="totalKishu">å¿…ä¿®å•é¡Œæ•°</th>
              <th class="a4-sortable" data-basis="totalIppan">ä¸€èˆ¬å•é¡Œæ•°</th>
              <th class="a4-sortable" data-basis="totalJokyo">çŠ¶æ³å•é¡Œæ•°</th>
              <th class="a4-sortable" data-basis="totalOver70">æ­£ç­”ç‡70%ä»¥ä¸Šã®å•é¡Œæ•°</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;

      a4RankingTable.innerHTML = tableHtml;

      const tableEl = a4RankingTable.querySelector("#a4Table");
      if (tableEl) {
        const ths = Array.from(tableEl.querySelectorAll("th[data-basis]"));
        ths.forEach((th) => {
          th.addEventListener("click", () => {
            const basis = th.getAttribute("data-basis") || "totalScore";
            currentA4Basis = basis;
            if (a4BasisSelect) a4BasisSelect.value = currentA4Basis;
            renderA4RankingTable();
          });
        });

        const basisToColIndex = {
          totalScore: 2,
          totalAll: 3,
          totalKishu: 4,
          totalIppan: 5,
          totalJokyo: 6,
          totalOver70: 7,
        };
        const colIdx = basisToColIndex[currentA4Basis] ?? 2;

        // header highlight
        tableEl.querySelectorAll("thead th").forEach((cell, i) => {
          cell.classList.toggle("a4-selected-col", i === colIdx);
        });

        // body highlight
        tableEl.querySelectorAll("tbody tr").forEach((tr) => {
          Array.from(tr.children).forEach((td, i) => {
            td.classList.toggle("a4-selected-col", i === colIdx);
          });
        });
      }
    }

    // ============================
    // A-4: ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡Œã‚¯ãƒªãƒƒã‚¯ã§ A-2 ã®è©²å½“RBCã¸é·ç§»
    // ============================
    function goToRbcFromA4(rbcName) {
      const name = String(rbcName || "").trim();
      if (!name) return;

      // A-4 -> A-2 ã¸é·ç§»ã—ã€RBCã‚’é¸æŠã—ãŸçŠ¶æ…‹ã«ã™ã‚‹ï¼ˆA-3ã¸ã¯é£›ã°ã•ãªã„ï¼‰
      // 1) ã¾ãš A-2 ã‚’è¡¨ç¤º
      showView("A2");

      // 2) A-2 ä¸Šéƒ¨ã®ã€Œç« ã€ã‚¿ãƒ–ã¯ã€å¯èƒ½ãªã‚‰ A-4 ã§é¸ã‚“ã§ã„ã‚‹ç« ã«åˆã‚ã›ã‚‹
      //    ï¼ˆcurrentA4Chapter ãŒç©ºãªã‚‰åˆã‚ã›ãªã„ï¼‰
      if (currentA4Chapter && chapterTabs) {
        const btn = chapterTabs.querySelector(`button[data-chapter="${CSS.escape(currentA4Chapter)}"]`);
        if (btn) {
          btn.click(); // currentChapter ã‚’æ›´æ–°ã—ã€RBCã‚¿ãƒ–ã‚’å†æ§‹ç¯‰
        }
      }

      // 3) RBC ãƒ•ã‚£ãƒ«ã‚¿å…¥åŠ›ã«åæ˜ ï¼ˆã‚¿ãƒ–ãŒå‡ºã‚‹UIã®ãŸã‚ï¼‰
      if (rbcFilterInput) {
        rbcFilterInput.value = name;
        currentRbcFilter = name;
        // buildRbcTabs ã¯ input ãƒãƒ³ãƒ‰ãƒ©ã«ã¶ã‚‰ä¸‹ãŒã£ã¦ã„ã‚‹ã®ã§æ˜ç¤ºçš„ã«å‘¼ã¶
        buildRbcTabs();
      }

      // 4) æ—¢å­˜ã®æ¤œç´¢å‡¦ç†ã‚’å†åˆ©ç”¨ï¼ˆã‚µãƒãƒªãƒ¼+å•é¡Œä¸€è¦§ã‚’è¡¨ç¤ºï¼‰
      if (rbcInput) rbcInput.value = name;
      if (searchButton) {
        searchButton.click();
      } else {
        // å¿µã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const qs = questions.filter((q) => String(q.rbcName || "").trim() === name);
        renderQuestionList(qs, name);
      }

      // A-4 ã‹ã‚‰æ¥ãŸã“ã¨ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«ãƒˆãƒ¼ã‚¹ãƒˆ
      showToast(`A-2ã§ã€Œ${name}ã€ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
    }
    window.goToRbcFromA4 = goToRbcFromA4;
    // ============================
    if (a3EditToggleButton) {
      a3EditToggleButton.addEventListener("click", () => {
        if (!currentQuestionCode) {
          alert("ç·¨é›†ã™ã‚‹å•é¡ŒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }
        const q = questions.find((item) => item.code === currentQuestionCode);
        if (!q) {
          alert(`å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ${currentQuestionCode}ï¼‰ã€‚`);
          return;
        }
        // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’åæ˜ 
        a3EditBody.value = q.body || "";
        a3EditChoice1.value = q.choices[0] || "";
        a3EditChoice2.value = q.choices[1] || "";
        a3EditChoice3.value = q.choices[2] || "";
        a3EditChoice4.value = q.choices[3] || "";
        a3EditChoice5.value = q.choices[4] || "";
        a3EditComment.value = q.comment || "";
        a3EditSection.style.display = "block";
        // ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        a3EditSection.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }

    if (a3CancelButton) {
      a3CancelButton.addEventListener("click", () => {
        a3EditSection.style.display = "none";
        showToast("ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚");
      });
    }

    if (a3SaveButton) {
      a3SaveButton.addEventListener("click", async () => {
        if (!currentQuestionCode) {
          alert("ç·¨é›†ã™ã‚‹å•é¡ŒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }
        const q = questions.find((item) => item.code === currentQuestionCode);
        if (!q) {
          alert(`å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ${currentQuestionCode}ï¼‰ã€‚`);
          return;
        }
        // å…¥åŠ›å€¤ã§ questions é…åˆ—å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆè¡¨ç¤ºç”¨ï¼‰
        q.body = a3EditBody.value || "";
        q.choices[0] = a3EditChoice1.value || "";
        q.choices[1] = a3EditChoice2.value || "";
        q.choices[2] = a3EditChoice3.value || "";
        q.choices[3] = a3EditChoice4.value || "";
        q.choices[4] = a3EditChoice5.value || "";
        q.comment = a3EditComment.value || "";

        // === å·®åˆ†ï¼ˆpatchï¼‰ã¨ã—ã¦ä¿å­˜ ===
        patch[currentQuestionCode] = {
          body: q.body,
          choices: q.choices.slice(), // é…åˆ—ã‚³ãƒ”ãƒ¼
          comment: q.comment,
        };

        // === D1ã¸ä¿å­˜ï¼ˆPages Functionsï¼‰===
        try {
          await savePatchToServer(currentQuestionCode, patch[currentQuestionCode]);
        } catch (e) {
          console.error(e);
          showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒï¼‰");
          // ãƒ­ãƒ¼ã‚«ãƒ«åæ˜ ã¯ã§ãã¦ã„ã‚‹ã®ã§æ­¢ã‚ãªã„
        }

        // é–‹ç™ºä¸­ç¢ºèªç”¨
        console.log("patch updated:", patch);

        // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã¦å†æç”»
        a3EditSection.style.display = "none";
        openQuestionDetail(currentQuestionCode, lastA3Origin);
        showToast("ä¿å­˜ã—ã¾ã—ãŸã€‚");
      });
    }

    // ============================
    // å•é¡ŒCSV(é …ç›®.csv) ã®èª­ã¿è¾¼ã¿
    // ============================

    function loadQuestionsFromCsv(csvText) {
      const table = parseTable(csvText);
      const headers = table.headers;
      const dataRows = table.rows;

      if (!headers.length || !dataRows.length) {
        alert("å•é¡ŒCSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      questions.length = 0;

      for (const cols of dataRows) {
        const q = {
          code: (cols[0] || "").trim(),
          rbcId: cols[1] ? Number(cols[1]) : null,
          rbcName: cols[2] || "",
          environment: cols[3] || "",
          body: cols[4] || "",
          choices: [
            cols[5] || "",
            cols[6] || "",
            cols[7] || "",
            cols[8] || "",
            cols[9] || "",
          ],
          answer: cols[10] || "",
          comment: cols[11] || "",
        };

        // rbc_small.csvï¼ˆrbcItemsï¼‰ã¨ join ã—ã¦ã€ç« ãªã©ã®ãƒ¡ã‚¿æƒ…å ±ã‚’ä»˜ä¸
        const qRbcId = Number.isFinite(q.rbcId) ? q.rbcId : null;
        const qRbcName = String(q.rbcName || "").trim();
        const master = (qRbcId != null)
          ? (rbcItems.find((it) => it.id === qRbcId) || null)
          : null;
        const masterByName = master || (qRbcName
          ? (rbcItems.find((it) => String(it.rbcName || "").trim() === qRbcName) || null)
          : null);

        q.chapter = masterByName ? String(masterByName.chapter || "").trim() : "";
        q.major = masterByName ? String(masterByName.major || "").trim() : "";
        q.middle = masterByName ? String(masterByName.middle || "").trim() : "";

        if (q.code && q.rbcName) {
          questions.push(q);
        }
      }

      console.log("å•é¡Œä»¶æ•°:", questions.length);
    }

    // ============================
    // 5) A-2 ã®çµæœãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    // ============================
    function renderResults(list, keyword) {
      if (list.length === 0) {
        resultsDiv.innerHTML = `<p class="no-result">"${keyword}" ã«ä¸€è‡´ã™ã‚‹RBCã®å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
        resultCount.textContent = "";
        return;
      }

      resultCount.textContent = `${list.length}ä»¶ãƒ’ãƒƒãƒˆã—ã¾ã—ãŸ`;

      const rows = list
        .map((item) => {
          return `
            <tr>
              <td>${item.id ?? ""}</td>
              <td>${item.chapter}</td>
              <td>${item.major}</td>
              <td>${item.middle}</td>
              <td>${item.rbcName}</td>

              <td>${item.totalAll}</td>
              <td>${item.totalAllRank ?? ""}</td>

              <td>${item.totalKishu}</td>
              <td>${item.totalKishuRank ?? ""}</td>

              <td>${item.totalIppan}</td>
              <td>${item.totalIppanRank ?? ""}</td>

              <td>${item.totalJokyo}</td>
              <td>${item.totalJokyoRank ?? ""}</td>
            </tr>
          `;
        })
        .join("");

      const tableHtml = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ç« </th>
              <th>å¤§é …ç›®</th>
              <th>ä¸­é …ç›®</th>
              <th>RBC(å°é …ç›®ï¼‰</th>
              <th>éå»10å¹´ã™ã¹ã¦</th>
              <th>åŒRBCrank</th>
              <th>å¿…ä¿®</th>
              <th>å¿…ä¿®rank</th>
              <th>ä¸€èˆ¬</th>
              <th>ä¸€èˆ¬rank</th>
              <th>çŠ¶æ³</th>
              <th>çŠ¶æ³rank</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      resultsDiv.innerHTML = tableHtml;
    }

    // ============================
    // æ­£ç­”ç‡CSV(æ­£ç­”ç‡.csv) ã®èª­ã¿è¾¼ã¿
    // ============================

    function loadQuestionStatsFromCsv(csvText) {
      const table = parseTable(csvText);
      const headers = table.headers;
      const dataRows = table.rows;

      if (!headers.length || !dataRows.length) {
        alert("æ­£ç­”ç‡CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      questionStats.length = 0;

      for (const cols of dataRows) {
        const s = {
          code: (cols[0] || "").trim(),
          rate: cols[1] !== "" && cols[1] != null ? Number(cols[1]) : null,
          choiceRates: [
            cols[2] !== "" && cols[2] != null ? Number(cols[2]) : null,
            cols[3] !== "" && cols[3] != null ? Number(cols[3]) : null,
            cols[4] !== "" && cols[4] != null ? Number(cols[4]) : null,
            cols[5] !== "" && cols[5] != null ? Number(cols[5]) : null,
            cols[6] !== "" && cols[6] != null ? Number(cols[6]) : null,
          ],
          discrimination: cols[7] !== "" && cols[7] != null ? Number(cols[7]) : null,
          over70Flag: cols[8] || "",
        };

        if (s.code) {
          questionStats.push(s);
        }
      }

      console.log("æ­£ç­”ç‡ä»¶æ•°:", questionStats.length);
    }

    // ============================
    // A-2: å•é¡Œç•ªå·ã§ã€Œæ–°ã—ã„å•é¡ŒãŒä¸Šã€ã«ãªã‚‹ã‚ˆã†ã«ä¸¦ã³æ›¿ãˆ
    // ä¾‹: 114P113, 113A093 ãªã©
    // å„ªå…ˆåº¦: å¹´(å…ˆé ­3æ¡) desc -> ç¨®åˆ¥(è‹±å­—) desc -> é€šã—ç•ªå·(æœ«å°¾) desc
    // ============================
    function parseQuestionCode(code) {
      const s = String(code || "").trim();
      // æƒ³å®š: 3æ¡ + è‹±å­—1ã€œ2 + 3æ¡ï¼ˆä¾‹: 114P113 / 112PA01 ãªã©ã®æºã‚Œã«ä¸€å¿œå¯¾å¿œï¼‰
      const m = s.match(/^(\d{3})([A-Za-z]{1,2})(\d{2,3})$/);
      if (!m) {
        // å½¢å¼ãŒé•ã†å ´åˆã¯ã€æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†ï¼ˆå¾Œæ®µã§é™é †ã‚½ãƒ¼ãƒˆï¼‰
        return { year: -1, type: "", num: -1, raw: s };
      }
      const year = Number(m[1]);
      const type = String(m[2] || "").toUpperCase();
      const num = Number(m[3]);
      return {
        year: Number.isFinite(year) ? year : -1,
        type,
        num: Number.isFinite(num) ? num : -1,
        raw: s,
      };
    }

    function compareQuestionCodeDesc(aCode, bCode) {
      const a = parseQuestionCode(aCode);
      const b = parseQuestionCode(bCode);

      // year desc
      if (a.year !== b.year) return b.year - a.year;

      // type desc (Z -> A)
      if (a.type !== b.type) return b.type.localeCompare(a.type);

      // num desc
      if (a.num !== b.num) return b.num - a.num;

      // fallback: raw desc
      return String(b.raw).localeCompare(String(a.raw));
    }

    // ============================
    // A-2: æŒ‡å®šRBCã®å•é¡Œä¸€è¦§ã‚’æç”»ï¼ˆé …ç›®.csvãƒ™ãƒ¼ã‚¹ï¼‰
    // ============================
    function renderQuestionList(list, keyword) {
      if (!list.length) {
        resultsDiv.innerHTML = `<p class="no-result">"${keyword}" ã«å¯¾å¿œã™ã‚‹å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
        resultCount.textContent = "";
        return;
      }

      // ã€Œæ–°ã—ã„å•é¡ŒãŒä¸Šã€ã«ãªã‚‹ã‚ˆã†ã«ä¸¦ã³æ›¿ãˆï¼ˆå…ƒé…åˆ—ã¯ç ´å£Šã—ãªã„ï¼‰
      const sortedList = list.slice().sort((qa, qb) => compareQuestionCodeDesc(qa.code, qb.code));

      resultCount.textContent = `${sortedList.length}ä»¶ãƒ’ãƒƒãƒˆã—ã¾ã—ãŸ`;

      const rows = sortedList
        .map((q) => {
          const stat = questionStats.find((s) => s.code === q.code) || null;
          const choiceRates = stat ? stat.choiceRates : [];

          const choicesHtml = q.choices
            .map((text, idx) => {
              if (!text) return "";
              const cleanedText = String(text).replace(/^\s*(?:[0-9ï¼-ï¼™]+[\.ï¼ã€)]\s*)+/u, "");
              const cr = choiceRates && choiceRates[idx] != null ? `${choiceRates[idx]}%` : "";
              const crText = cr ? `ï¼ˆ${cr}ï¼‰` : "";
              return `${idx + 1}. ${cleanedText}${crText}`;
            })
            .filter((s) => s !== "")
            .join("<br />");

          const rateText = stat && stat.rate != null ? `${stat.rate}%` : "";
          const discrText = stat && stat.discrimination != null ? `${stat.discrimination}` : "";

          return `
            <tr onclick="openQuestionDetail('${q.code}', 'A2')">
              <td>${q.code}</td>
              <td>${q.environment || ""}</td>
              <td>${q.body || ""}</td>
              <td>${choicesHtml}</td>
              <td>${rateText}</td>
              <td>${discrText}</td>
            </tr>
          `;
        })
        .join("");

      const tableHtml = `
        <table>
          <thead>
            <tr>
              <th>å•é¡Œç•ªå·</th>
              <th>çŠ¶æ³è¨­å®šæ–‡</th>
              <th>å•é¡Œæ–‡</th>
              <th>é¸æŠè‚¢</th>
              <th>æ­£ç­”ç‡</th>
              <th>è­˜åˆ¥å€¤</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      resultsDiv.innerHTML = tableHtml;
    }

    // ============================
    // A-3: å•é¡Œè©³ç´°ç”»é¢ã¸é·ç§»ã—ã¦æç”»
    // ============================
    async function openQuestionDetail(code, origin) {
      currentQuestionCode = code;
      lastA3Origin = (origin === "A4") ? "A4" : "A2";
      const backToA2Btn = document.getElementById("btnA3BackToA2");
      const backToA4Btn = document.getElementById("btnA3BackToA4");
      if (backToA2Btn && backToA4Btn) {
        if (lastA3Origin === "A4") {
          backToA2Btn.style.display = "none";
          backToA4Btn.style.display = "inline-flex";
        } else {
          backToA2Btn.style.display = "inline-flex";
          backToA4Btn.style.display = "none";
        }
      }
      // D1ã«ä¿å­˜ã•ã‚ŒãŸç·¨é›†å·®åˆ†ã‚’å–ã‚Šè¾¼ã¿ã€è¡¨ç¤ºã«åæ˜ 
      await applyPatchToQuestion(code);

      const q = questions.find((item) => item.code === code);
      if (!q) {
        alert(`å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ${code}ï¼‰ã€‚`);
        return;
      }

      // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã¯æ–°ã—ã„å•é¡Œã‚’é–‹ã„ãŸã¨ãã«ã¯é–‰ã˜ã¦ãŠã
      if (a3EditSection) {
        a3EditSection.style.display = "none";
      }

      const stat = questionStats.find((s) => s.code === code) || null;

      // å•é¡Œç•ªå·
      a3Code.textContent = code;

      // å•é¡Œæ–‡ï¼ˆHTMLã‚¿ã‚°ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ innerHTML ã‚’ä½¿ã†ï¼‰
      a3Body.innerHTML = q.body || "";
      renderQuestionImagesByCode(code, q.explanation);

      // é¸æŠè‚¢ + é¸æŠç‡
      const choiceRates = stat ? stat.choiceRates : [];
      const itemsHtml = q.choices
        .map((text, idx) => {
          if (!text) return "";
          const cleanedText = String(text).replace(/^\s*(?:[0-9ï¼-ï¼™]+[\.ï¼ã€)]\s*)+/u, "");
          const rate = choiceRates && choiceRates[idx] != null
            ? `${choiceRates[idx]}%`
            : "";
          const rateText = rate ? `ï¼ˆ${rate}ï¼‰` : "";
          return `<li>${cleanedText}${rateText}</li>`;
        })
        .join("");

      a3Choices.innerHTML = itemsHtml;

      // è§£ç­”
      if (q.answer) {
        a3Answer.textContent = q.answer;
      } else {
        a3Answer.textContent = "è§£ç­”ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
      }

      // æ­£ç­”ç‡
      if (stat && stat.rate != null) {
        a3Rate.textContent = `${stat.rate}%`;
      } else {
        a3Rate.textContent = "æ­£ç­”ç‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
      }

      // è§£èª¬: <ex>ã€œ</ex> ã‚’æ®µè½ã«å¤‰æ›ã—ã¦è¡¨ç¤º
      const formatExText = (text) => {
        if (!text) return "";

        // 1) Normalize newlines
        let html = String(text)
          .replace(/\r\n/g, "\n")
          .replace(/\r/g, "\n");

        // Convert custom paragraph markers safely (avoid regex literal edge-cases)
        html = html.split("<ex>").join("<p>");
        html = html.split("</ex>").join("</p>");

        // 3) Render CSV newlines as visible line breaks in the site
        //    - single \n => <br>
        //    - multiple \n => <br><br>
        html = html.replace(/\n{2,}/g, "<br><br>").replace(/\n/g, "<br>");

        return html;
      };

      const ex = q.explanation || {};
      const labelMap = {
        comment: "è§£èª¬",
        editor_comment: "ç·¨é›†è€…å‘ã‘ã®è§£èª¬",
        editor_coment: "ç·¨é›†è€…å‘ã‘ã®è§£èª¬", // CSVå´ã®ç¶´ã‚ŠãƒŸã‚¹å¸å
        clinical: "å‡ºé¡Œè€…ã®æ„å›³ãƒ»è‡¨åºŠçš„æ„ç¾©",
        clinical_significance: "å‡ºé¡Œè€…ã®æ„å›³ãƒ»è‡¨åºŠçš„æ„ç¾©",
        statsTrend: "é¸æŠç‡ã¨åå·®å€¤ã®æ¨ç§»",
        stats_trend: "é¸æŠç‡ã¨åå·®å€¤ã®æ¨ç§»",
      };
      const preferredOrder = [
        "comment",
        "editor_comment",
        "editor_coment",
        "clinical_significance",
        "clinical",
        "stats_trend",
        "statsTrend",
      ];
      const codeKeys = ["question_code", "code", "questionCode"];

      // ã€Œç”»åƒã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ—§UIã®å€™è£œãƒªãƒ³ã‚¯/å£Šã‚Œç”»åƒã‚’å‡ºã™é ˜åŸŸï¼‰ã¯ä½¿ã‚ãªã„ã®ã§é™¤å¤–
      const imageKeys = [
        "image",
        "image_id",
        "imageid",
        "images",
        "img",
        "imgs",
        "picture",
        "pictures",
        "photo",
        "photos",
        "ç”»åƒ",
      ];

      const allKeys = Object.keys(ex).filter((key) => {
        if (codeKeys.includes(key)) return false;
        const k = String(key || "").trim().toLowerCase();
        if (imageKeys.includes(k)) return false;
        if (k === "image_id" || k === "imageid") return false;
        if (k.includes("image") || k.includes("img") || k.includes("picture") || k.includes("photo")) return false;
        // æ—¥æœ¬èªã‚­ãƒ¼å¯¾ç­–
        if (String(key || "").trim() === "ç”»åƒ") return false;
        return true;
      });
      const orderedKeys = [
        ...preferredOrder.filter((key) => allKeys.includes(key)),
        ...allKeys
          .filter((key) => !preferredOrder.includes(key))
          .sort((a, b) => a.localeCompare(b)),
      ];

      const sectionsHtml = orderedKeys
        .map((key) => {
          const rawValue = ex[key];
          const value = rawValue != null ? String(rawValue) : "";
          if (!value.trim()) return "";
          const title = labelMap[key] || key;

          // ã€Œé¸æŠç‡ã¨åå·®å€¤ã®æ¨ç§»ã€ã«ã¯ã€å¯¾å¿œç”»åƒï¼ˆdata/images_rbc_analysis/<code>.pngï¼‰ãŒã‚ã‚Œã°æ¨ªã«è¡¨ç¤º
          const keyLower = String(key || "").trim().toLowerCase();
          if (keyLower === "stats_trend" || keyLower === "statstrend" || title === "é¸æŠç‡ã¨åå·®å€¤ã®æ¨ç§»") {
            // trendç”»åƒã¯ data/images_rbc_analysis/<question_code>.png ã‚’æœ€å„ªå…ˆã§æ¢ã™
            // ï¼ˆä¾‹: 113A093.png ã®ã‚ˆã†ã« question_code ã¨å®Œå…¨ä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
            const trendCandidates = buildTrendImageCandidates(code);
            const rawCode = String(code || "").trim();
            const holderId = `trend_img_${rawCode}`.replace(/[^a-zA-Z0-9_\-]/g, "_");

            return `
              <details class="accordion-item" open>
                <summary>${title}</summary>
                <div class="accordion-body">
                  <div class="a3-trend-wrap">
                    <div class="a3-trend-text">${formatExText(value)}</div>
                    <div class="a3-trend-image is-loading" id="${holderId}" data-trend-code="${rawCode}"></div>
                  </div>
                </div>
              </details>
            `;
          }

          return `
            <details class="accordion-item" open>
              <summary>${title}</summary>
              <div class="accordion-body">${formatExText(value)}</div>
            </details>
          `;
        })
        .filter((html) => html !== "")
        .join("");

      a3Comment.innerHTML = sectionsHtml;

      // ã€Œé¸æŠç‡ã¨åå·®å€¤ã®æ¨ç§»ã€: å¯¾å¿œç”»åƒãŒã‚ã‚Œã°æ¨ªã«è¡¨ç¤ºï¼ˆç„¡ã‘ã‚Œã°ä½•ã‚‚å‡ºã•ãªã„ï¼‰
      // é‡è¦: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ç”»åƒã§ã‚‚ onload ãŒç¢ºå®Ÿã«å‹•ãã‚ˆã†ã«ã€onload/onerror ã‚’å…ˆã«è¨­å®šã—ã¦ã‹ã‚‰ src ã‚’å…¥ã‚Œã‚‹
      Array.from(a3Comment.querySelectorAll('[data-trend-code]')).forEach((holder) => {
        const qcode = String(holder.getAttribute('data-trend-code') || '').trim();
        if (!qcode) return;

        const cands = buildTrendImageCandidates(qcode);
        if (!cands.length) return;

        holder.innerHTML = "";

        const imgEl = document.createElement("img");
        imgEl.decoding = "async";
        // NOTE: holder ã‚’ display:none ã«ã™ã‚‹ã¨ lazy ãŒç™ºç«ã—ãªã„ã“ã¨ãŒã‚ã‚‹ãŸã‚ eager ã«ã™ã‚‹
        imgEl.loading = "eager";
        imgEl.alt = "é¸æŠç‡ã¨åå·®å€¤ã®æ¨ç§»";

        let idx = 0;
        const setSrc = (url) => {
          const bust = `v=${Date.now()}`;
          imgEl.src = url.includes("?") ? `${url}&${bust}` : `${url}?${bust}`;
          // ãƒ‡ãƒãƒƒã‚°: Networkã§ `images_rbc_analysis` ãŒè¦‹ãˆã‚‹ã¯ãš
          console.log("trend image try:", qcode, imgEl.src);
        };

        // å…ˆã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã§ã‚‚ onload ã‚’å–ã‚Šã“ã¼ã•ãªã„ï¼‰
        imgEl.onload = () => {
          holder.classList.remove("is-empty");
          holder.classList.remove("is-loading");
        };

        imgEl.onerror = () => {
          const tried = cands[idx];
          idx += 1;
          if (idx < cands.length) {
            setSrc(cands[idx]);
            return;
          }
          // ç”»åƒãŒç„¡ã„ï¼ˆor ãƒ‡ã‚³ãƒ¼ãƒ‰ã§ããªã„ï¼‰å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
          console.warn("trend image not found:", qcode, "last tried:", tried, "candidates:", cands);
          holder.innerHTML = "";
          holder.classList.add("is-empty");
          holder.classList.remove("is-loading");
        };

        // DOMã¸å…ˆã«å…¥ã‚Œã‚‹ï¼ˆè¡¨ç¤ºé ˜åŸŸç¢ºä¿ï¼‰
        holder.appendChild(imgEl);

        // ãƒ­ãƒ¼ãƒ‰ä¸­ã¯ is-loadingï¼ˆdisplay:none ã«ã—ãªã„ï¼‰
        holder.classList.remove("is-empty");
        holder.classList.add("is-loading");

        // æœ€åˆã®å€™è£œã‹ã‚‰é †ã«è©¦ã™
        setSrc(cands[idx]);
      });

      // ç”»é¢ã‚’ A-3 ã«åˆ‡ã‚Šæ›¿ãˆ
      showView("A3");
    }
    // Expose for inline onclick handlers in tables
    window.openQuestionDetail = openQuestionDetail;
  </script>
</body>
</html>
