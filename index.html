<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å›½è©¦åˆ†æ</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      max-width: 1000px;
      margin: 24px auto;
      padding: 0 16px;
      line-height: 1.6;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.25rem;
    }
    .subtitle {
      color: #555;
      margin-bottom: 1rem;
    }

    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆA-1ã€œA-4ï¼‰ */
    .nav {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .nav button {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .nav button.active {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }
    .tab-button {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .tab-button.active {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }

    /* ç”»é¢ã‚³ãƒ³ãƒ†ãƒŠ */
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }

    /* A-2 ä»¥é™ã§ä½¿ã†å…±é€šãƒ‘ãƒ¼ãƒ„ */
    .search-box {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    /* A-2 ã®æ—§ãƒ»RBCåæ¤œç´¢æ¬„ã¯ãƒ­ã‚¸ãƒƒã‚¯ç”¨ã«æ®‹ã—ã¤ã¤ç”»é¢ã«ã¯è¡¨ç¤ºã—ãªã„ */
    label[for="rbcInput"],
    #rbcInput,
    #searchButton,
    #clearButton {
      display: none;
    }
    button.primary {
      margin-top: 8px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      background-color: #2563eb;
      color: white;
    }
    button.secondary {
      margin-top: 8px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      background-color: #e5e7eb;
    }
    .result-count {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background-color: #f3f4f6;
    }
    .no-result {
      margin-top: 12px;
      color: #b91c1c;
      font-size: 0.9rem;
    }
    .section-title {
      font-weight: bold;
      margin-bottom: 4px;
      margin-top: 8px;
    }
    #a3Body {
      margin-top: 4px;
    }
    #a3Comment p {
      margin: 4px 0;
    }

    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h1>å›½è©¦åˆ†æ</h1>
  <p class="subtitle">å›½è©¦åˆ†æç”»é¢</p>

  <!-- A-1ã€œA-4 ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="nav">
    <button id="navA1" class="active">A-1 ãƒ›ãƒ¼ãƒ </button>
    <button id="navA2">A-2 RBCã‹ã‚‰æ¤œç´¢</button>
    <button id="navA4">A-4 å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰æ¤œç´¢</button>
  </div>

  <!-- A-1 ãƒ›ãƒ¼ãƒ ç”»é¢ -->
  <div id="viewA1" class="view active">
    <p>å›½è©¦ã®RBCåˆ¥åˆ†æãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
    <p class="section-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</p>
    <ul>
      <li><button class="primary" onclick="showView('A2')">RBCã‹ã‚‰æ¤œç´¢ï¼ˆA-2ã¸ï¼‰</button></li>
      <li><button class="secondary" onclick="showView('A4')">å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰æ¤œç´¢ï¼ˆA-4ã¸ï¼‰</button></li>
    </ul>
  </div>

  <!-- A-2 RBCã‹ã‚‰æ¤œç´¢ç”»é¢ -->
  <div id="viewA2" class="view">
    <h2>å›½è©¦åˆ†æç”»é¢ RBCã‹ã‚‰æ¤œç´¢ï¼ˆA-2ï¼‰</h2>

    <!-- ç« ã‚¿ãƒ– / RBCã‚¿ãƒ– -->
    <div id="chapterTabsContainer" style="margin-top: 8px;">
      <div class="section-title">ç« </div>
      <div id="chapterTabs" class="tabs"></div>
    </div>

    <div id="rbcTabsContainer" style="margin-top: 8px;">
      <div class="section-title">RBC</div>
      <div style="margin-bottom: 4px;">
        <input
          id="rbcFilterInput"
          type="text"
          placeholder="ã“ã®ç« ã®RBCã‚’çµã‚Šè¾¼ã¿ï¼ˆä¾‹: é…¸ç´ , ä¸Šçš® ãªã©ï¼‰"
          style="width:100%; padding:6px 8px; border-radius:4px; border:1px solid #ccc; font-size:0.85rem;"
        />
      </div>
      <div id="rbcTabs" class="tabs"></div>
    </div>

    <!-- RBCã®æ¦‚è¦è¡¨ç¤ºï¼ˆç«  / RBC / åˆè¨ˆã€œå•ã€œä½ â€¦ï¼‰ -->
    <div id="a2Summary" style="margin: 12px 0; display:none;">
      <div><span class="section-title">ç« </span> <span id="a2Chapter"></span></div>
      <div><span class="section-title">RBC</span> <span id="a2RbcName"></span></div>
      <div>
        <span class="section-title">åˆè¨ˆ</span>
        <span id="a2TotalAll"></span>å•
        ï¼ˆ<span id="a2TotalAllRank"></span>ä½ï¼‰
      </div>
      <div>
        å¿…ä¿® <span id="a2Kishu"></span>å•ã€€
        ä¸€èˆ¬ <span id="a2Ippan"></span>å•ã€€
        çŠ¶æ³ <span id="a2Jokyo"></span>å•
      </div>
    </div>

    <!-- ğŸ” æ¤œç´¢ã‚¨ãƒªã‚¢ï¼ˆã„ã¾ã¾ã§ä½œã£ã¦ããŸã‚‚ã®ï¼‰ -->
    <div class="search-box">
      <label for="rbcInput">RBCåã§æ¤œç´¢</label>
      <input id="rbcInput" type="text" placeholder="ä¾‹: ç´°èƒç·è«–ã€ä¸Šçš®çµ„ç¹” ãªã©" />
      <button id="searchButton" class="primary">æ¤œç´¢</button>
      <button id="clearButton" class="secondary">ã‚¯ãƒªã‚¢</button>

      <div style="margin-top: 12px;">
        <label for="rbcCsvInput">RBCãƒã‚¹ã‚¿CSV(rbc_small)ã‚’èª­ã¿è¾¼ã‚€</label>
        <input id="rbcCsvInput" type="file" accept=".csv,.tsv" />
      </div>

      <div style="margin-top: 12px;">
        <label for="questionCsvInput">å•é¡ŒCSV(é …ç›®.csv)ã‚’èª­ã¿è¾¼ã‚€</label>
        <input id="questionCsvInput" type="file" accept=".csv,.tsv" />
      </div>

      <div style="margin-top: 12px;">
        <label for="statsCsvInput">æ­£ç­”ç‡CSV(æ­£ç­”ç‡.csv)ã‚’èª­ã¿è¾¼ã‚€</label>
        <input id="statsCsvInput" type="file" accept=".csv,.tsv" />
      </div>

      <div id="resultCount" class="result-count"></div>
    </div>

    <!-- ğŸ“‹ çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="results"></div>
  </div>

  <!-- A-3 å•é¡Œè©³ç´°ç”»é¢ -->
  <div id="viewA3" class="view">
    <h2>å›½è©¦åˆ†æç”»é¢ å•é¡Œè©³ç´°ï¼ˆA-3ï¼‰</h2>

    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <div id="a3Code" style="font-size: 2rem; font-weight: bold;">å•é¡Œç•ªå·</div>
      <div>
        <button id="a3EditToggleButton" class="primary" style="margin-right: 8px;">ç·¨é›†</button>
        <button class="secondary" onclick="showView('A2')">å‰ã®æ¤œç´¢ã¸ï¼ˆA-2ã«æˆ»ã‚‹ï¼‰</button>
      </div>
    </div>

    <div style="margin-bottom: 16px;">
      <div class="section-title">å•é¡Œæ–‡</div>
      <div id="a3Body"></div>
    </div>

    <div style="margin-bottom: 16px;">
      <div class="section-title">é¸æŠè‚¢</div>
      <ol id="a3Choices" style="padding-left: 1.5rem;"></ol>
    </div>

    <div style="margin-bottom: 16px;">
      <div class="section-title">æ­£ç­”ç‡</div>
      <div id="a3Rate"></div>
    </div>

    <div style="margin-bottom: 16px;">
      <div class="section-title">è§£èª¬</div>
      <div id="a3Comment"></div>
    </div>

    <div id="a3EditSection" style="margin-top: 16px; display:none;">
      <div class="section-title">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</div>

      <div style="margin-bottom: 12px;">
        <label for="a3EditBody">å•é¡Œæ–‡ï¼ˆç·¨é›†ï¼‰</label>
        <textarea id="a3EditBody"></textarea>
      </div>

      <div style="margin-bottom: 12px;">
        <label for="a3EditChoice1">é¸æŠè‚¢1</label>
        <input id="a3EditChoice1" type="text" />
      </div>
      <div style="margin-bottom: 12px;">
        <label for="a3EditChoice2">é¸æŠè‚¢2</label>
        <input id="a3EditChoice2" type="text" />
      </div>
      <div style="margin-bottom: 12px;">
        <label for="a3EditChoice3">é¸æŠè‚¢3</label>
        <input id="a3EditChoice3" type="text" />
      </div>
      <div style="margin-bottom: 12px;">
        <label for="a3EditChoice4">é¸æŠè‚¢4</label>
        <input id="a3EditChoice4" type="text" />
      </div>
      <div style="margin-bottom: 12px;">
        <label for="a3EditChoice5">é¸æŠè‚¢5</label>
        <input id="a3EditChoice5" type="text" />
      </div>

      <div style="margin-bottom: 12px;">
        <label for="a3EditComment">è§£èª¬ï¼ˆç·¨é›†ï¼‰</label>
        <textarea id="a3EditComment"></textarea>
      </div>

      <button id="a3SaveButton" class="primary">ä¿å­˜</button>
      <button id="a3CancelButton" class="secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- A-4 å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ -->
  <div id="viewA4" class="view">
    <h2>å›½è©¦åˆ†æç”»é¢ å‡ºé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰æ¤œç´¢ï¼ˆA-4ï¼‰</h2>

    <div class="search-box">
      <div style="display:flex; gap:16px; flex-wrap:wrap;">
        <div style="flex:1 1 200px;">
          <label for="a4ChapterSelect">ç« </label>
          <select id="a4ChapterSelect" style="width:100%; padding:8px; border-radius:4px; border:1px solid #ccc;">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        <div style="flex:1 1 200px;">
          <label for="a4BasisSelect">åŸºæº–</label>
          <select id="a4BasisSelect" style="width:100%; padding:8px; border-radius:4px; border:1px solid #ccc;">
            <option value="totalAll">åˆè¨ˆå•é¡Œæ•°</option>
            <option value="totalKishu">å¿…ä¿®å•é¡Œæ•°</option>
            <option value="totalIppan">ä¸€èˆ¬å•é¡Œæ•°</option>
            <option value="totalJokyo">çŠ¶æ³å•é¡Œæ•°</option>
            <option value="totalOver70">æ­£ç­”ç‡70%ä»¥ä¸Šã®å•é¡Œæ•°</option>
          </select>
        </div>
      </div>
      <p class="subtitle" style="margin-top:8px; font-size:0.8rem;">
        â€» åŸºæº–ã¯ã€Œåˆè¨ˆå•é¡Œæ•° / å¿…ä¿® / ä¸€èˆ¬ / çŠ¶æ³ / æ­£ç­”ç‡70%ä»¥ä¸Šã®å•é¡Œæ•°ã€ã§ã‚½ãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚
      </p>
    </div>

    <div id="a4RankingCount" class="result-count"></div>

    <div id="a4RankingTable"></div>

    <button class="secondary" onclick="showView('A1')" style="margin-top:16px;">ãƒ›ãƒ¼ãƒ ï¼ˆA-1ï¼‰ã«æˆ»ã‚‹</button>
  </div>

  <!-- ğŸ“¦ JavaScript -->
  <script>
    // ============================
    // 0) ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆï¼ˆA-1ã€œA-4ï¼‰
    // ============================
    const viewA1 = document.getElementById("viewA1");
    const viewA2 = document.getElementById("viewA2");
    const viewA3 = document.getElementById("viewA3");
    const viewA4 = document.getElementById("viewA4");

    const navA1 = document.getElementById("navA1");
    const navA2 = document.getElementById("navA2");
    const navA4 = document.getElementById("navA4");

    function showView(name) {
      // view ã®è¡¨ç¤º/éè¡¨ç¤º
      [viewA1, viewA2, viewA3, viewA4].forEach((v) => v.classList.remove("active"));
      if (name === "A1") viewA1.classList.add("active");
      if (name === "A2") viewA2.classList.add("active");
      if (name === "A3") viewA3.classList.add("active");
      if (name === "A4") viewA4.classList.add("active");

      // ãƒŠãƒ“ã®çŠ¶æ…‹
      [navA1, navA2, navA4].forEach((b) => b.classList.remove("active"));
      if (name === "A1") navA1.classList.add("active");
      if (name === "A2") navA2.classList.add("active");
      if (name === "A4") navA4.classList.add("active");
    }

    // ãƒŠãƒ“ãƒœã‚¿ãƒ³ã«ã‚‚ showView ã‚’ã¤ãªã
    navA1.addEventListener("click", () => showView("A1"));
    navA2.addEventListener("click", () => showView("A2"));
    navA4.addEventListener("click", () => showView("A4"));

    // ============================
    // 1) ãƒ‡ãƒ¼ã‚¿é…åˆ—
    // ============================
    const questions = []; // é …ç›®.csv ã®å•é¡Œãƒ‡ãƒ¼ã‚¿
    const rbcItems = [];  // rbc_small.csv ã®å†…å®¹
    const questionStats = []; // æ­£ç­”ç‡.csv ã®ãƒ‡ãƒ¼ã‚¿

    // ============================
    // 2) HTMLè¦ç´ ã‚’ã¤ã‹ã‚€ï¼ˆA-2ï¼‰
    // ============================
    const rbcInput = document.getElementById("rbcInput");
    const searchButton = document.getElementById("searchButton");
    const clearButton = document.getElementById("clearButton");
    const resultsDiv = document.getElementById("results");
    const resultCount = document.getElementById("resultCount");
    const rbcCsvInput = document.getElementById("rbcCsvInput");

    const questionCsvInput = document.getElementById("questionCsvInput");
    const statsCsvInput = document.getElementById("statsCsvInput");

    // A-2 ã‚µãƒãƒªãƒ¼éƒ¨
    const a2Summary = document.getElementById("a2Summary");
    const a2Chapter = document.getElementById("a2Chapter");
    const a2RbcName = document.getElementById("a2RbcName");
    const a2TotalAll = document.getElementById("a2TotalAll");
    const a2TotalAllRank = document.getElementById("a2TotalAllRank");
    const a2Kishu = document.getElementById("a2Kishu");
    const a2Ippan = document.getElementById("a2Ippan");
    const a2Jokyo = document.getElementById("a2Jokyo");

    // A-3 å•é¡Œè©³ç´°éƒ¨
    const a3Code = document.getElementById("a3Code");
    const a3Body = document.getElementById("a3Body");
    const a3Choices = document.getElementById("a3Choices");
    const a3Rate = document.getElementById("a3Rate");
    const a3Comment = document.getElementById("a3Comment");

    // A-3 ç·¨é›†è¦ç´ 
    const a3EditToggleButton = document.getElementById("a3EditToggleButton");
    const a3EditSection = document.getElementById("a3EditSection");
    const a3EditBody = document.getElementById("a3EditBody");
    const a3EditChoice1 = document.getElementById("a3EditChoice1");
    const a3EditChoice2 = document.getElementById("a3EditChoice2");
    const a3EditChoice3 = document.getElementById("a3EditChoice3");
    const a3EditChoice4 = document.getElementById("a3EditChoice4");
    const a3EditChoice5 = document.getElementById("a3EditChoice5");
    const a3EditComment = document.getElementById("a3EditComment");
    const a3SaveButton = document.getElementById("a3SaveButton");
    const a3CancelButton = document.getElementById("a3CancelButton");

    // A-2 ç«  / RBC ã‚¿ãƒ–
    const chapterTabs = document.getElementById("chapterTabs");
    const rbcTabs = document.getElementById("rbcTabs");
    const rbcFilterInput = document.getElementById("rbcFilterInput");
    // A-4 ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨è¦ç´ 
    const a4ChapterSelect = document.getElementById("a4ChapterSelect");
    const a4BasisSelect = document.getElementById("a4BasisSelect");
    const a4RankingTable = document.getElementById("a4RankingTable");
    const a4RankingCount = document.getElementById("a4RankingCount");
    // çŠ¶æ…‹ç®¡ç†ç”¨
    let currentChapter = null;
    let currentRbc = null;
    let currentRbcFilter = "";
    let currentQuestionCode = null;
    let currentA4Chapter = "";
    let currentA4Basis = "totalAll";

    // ============================
    // 3) æ¤œç´¢ãƒœã‚¿ãƒ³ï¼ˆA-2ï¼‰
    // ============================
    searchButton.addEventListener("click", () => {
      const keyword = rbcInput.value.trim();
      if (keyword === "") {
        alert("RBCåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const lowerKeyword = keyword.toLowerCase();

      // A-2 ä¸‹åŠåˆ†ï¼šé …ç›®.csv ã‹ã‚‰è©²å½“RBCã®å•é¡Œãƒªã‚¹ãƒˆã‚’å–å¾—
      const qs = questions.filter(
        (q) => q.rbcName && q.rbcName.toLowerCase().includes(lowerKeyword)
      );

      // A-2 ä¸Šéƒ¨ã‚µãƒãƒªãƒ¼ã‚‚ questions ãƒ™ãƒ¼ã‚¹ã§è¡¨ç¤º
      if (qs.length > 0) {
        const qfirst = qs[0];
        a2Chapter.textContent = qfirst.chapter || "";
        a2RbcName.textContent = qfirst.rbcName || "";
        a2TotalAll.textContent = qs.length;
        a2TotalAllRank.textContent = "";
        a2Kishu.textContent = "";
        a2Ippan.textContent = "";
        a2Jokyo.textContent = "";
        a2Summary.style.display = "block";
      } else {
        a2Summary.style.display = "none";
      }

      renderQuestionList(qs, keyword);
      showView("A2"); // A-1 ã‹ã‚‰æ¤œç´¢ã—ã¦ããŸå ´åˆã§ã‚‚ A-2 ã‚’è¡¨ç¤ºã™ã‚‹
    });

    // Enterã‚­ãƒ¼ã§ã‚‚æ¤œç´¢
    rbcInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        searchButton.click();
      }
    });

    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    clearButton.addEventListener("click", () => {
      rbcInput.value = "";
      resultCount.textContent = "";
      resultsDiv.innerHTML = "";
      a2Summary.style.display = "none";
      rbcInput.focus();
    });

    // ============================
    // 4) RBCãƒã‚¹ã‚¿CSV ã®èª­ã¿è¾¼ã¿
    // ============================
    rbcCsvInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();

      reader.onload = (e) => {
        const text = e.target.result;
        loadRbcItemsFromCsv(text);
        alert("rbc_small ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚RBCåã§æ¤œç´¢ã§ãã¾ã™ã€‚");
      };

      reader.onerror = () => {
        alert("rbc_small èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      };

      reader.readAsText(file, "UTF-8");
    });

    function loadRbcItemsFromCsv(csvText) {
      const lines = csvText
        .split(/\r?\n/)
        .map((line) => line.trim())
        .filter((line) => line !== "");

      if (lines.length <= 1) {
        alert("CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      const dataLines = lines.slice(1);
      rbcItems.length = 0;

      for (const line of dataLines) {
        const cols = line.split(/\t|,/); // ã‚¿ãƒ– or ã‚«ãƒ³ãƒä¸¡å¯¾å¿œ

        const item = {
          id: Number(cols[0]) || null,
          chapter: cols[1] || "",
          major: cols[2] || "",
          middle: cols[3] || "",
          rbcName: cols[4] || "",

          order: Number(cols[5]) || null,
          valid: cols[6] === "1",
          master: cols[7] === "1",

          totalAll: Number(cols[8]) || 0,
          totalAllRank: Number(cols[9]) || null,

          totalKishu: Number(cols[10]) || 0,
          totalKishuRank: Number(cols[11]) || null,

          totalIppan: Number(cols[12]) || 0,
          totalIppanRank: Number(cols[13]) || null,

          totalJokyo: Number(cols[14]) || 0,
          totalJokyoRank: Number(cols[15]) || null,

          totalOver70: Number(cols[16]) || 0,
          totalOver70Rank: Number(cols[17]) || null,
        };

        if (item.rbcName) {
          rbcItems.push(item);
        }
      }

      console.log("RBCä»¶æ•°:", rbcItems.length);
      buildChapterTabs();
      buildA4Filters();
    }

    // ============================
    // ç« ã‚¿ãƒ– / RBCã‚¿ãƒ–ã®æ§‹ç¯‰
    // ============================
    function buildChapterTabs() {
      if (!rbcItems.length || !chapterTabs) return;

      // ä¸€æ„ãªç« ä¸€è¦§ã‚’å–å¾—
      const chapters = [...new Set(
        rbcItems
          .map((item) => item.chapter)
          .filter((ch) => ch && ch.trim() !== "")
      )];

      chapters.sort();

      chapterTabs.innerHTML = chapters
        .map(
          (ch) =>
            `<button class="tab-button" data-chapter="${ch}">${ch}</button>`
        )
        .join("");

      currentChapter = null;
      currentRbc = null;
      if (rbcTabs) {
        rbcTabs.innerHTML = "";
      }

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      Array.from(chapterTabs.querySelectorAll("button")).forEach((btn) => {
        btn.addEventListener("click", () => {
          currentChapter = btn.getAttribute("data-chapter");

          // è¦‹ãŸç›®ã® active åˆ‡ã‚Šæ›¿ãˆ
          chapterTabs
            .querySelectorAll("button")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // RBCãƒ•ã‚£ãƒ«ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
          currentRbcFilter = "";
          if (rbcFilterInput) {
            rbcFilterInput.value = "";
          }

          buildRbcTabs();
        });
      });
    }

    function buildRbcTabs() {
      if (!currentChapter || !rbcTabs) {
        if (rbcTabs) rbcTabs.innerHTML = "";
        return;
      }

      // ãƒ•ã‚£ãƒ«ã‚¿å…¥åŠ›å€¤ã§RBCåã‚’çµã‚Šè¾¼ã‚€
      const lowerFilter = currentRbcFilter
        ? currentRbcFilter.trim().toLowerCase()
        : "";

      // ãƒ•ã‚£ãƒ«ã‚¿ãŒç©ºã®ã¨ãã¯ã‚¿ãƒ–ã‚’è¡¨ç¤ºã—ãªã„
      if (!lowerFilter) {
        rbcTabs.innerHTML = "";
        currentRbc = null;
        return;
      }

      const rbcs = rbcItems
        .filter((item) => item.chapter === currentChapter)
        .map((item) => item.rbcName)
        .filter((name) => {
          if (!name) return false;
          const trimmed = name.trim();
          if (!trimmed) return false;
          return trimmed.toLowerCase().includes(lowerFilter);
        });

      const uniqueRbcs = [...new Set(rbcs)];
      uniqueRbcs.sort();

      rbcTabs.innerHTML = uniqueRbcs
        .map(
          (name) =>
            `<button class="tab-button" data-rbc="${name}">${name}</button>`
        )
        .join("");

      currentRbc = null;

      // ã‚¯ãƒªãƒƒã‚¯ã§RBCã‚’é¸æŠã—ã€æ—¢å­˜ã®æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
      Array.from(rbcTabs.querySelectorAll("button")).forEach((btn) => {
        btn.addEventListener("click", () => {
          currentRbc = btn.getAttribute("data-rbc");

          rbcTabs
            .querySelectorAll("button")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // æ—¢å­˜ã®æ¤œç´¢å‡¦ç†ã‚’å†åˆ©ç”¨
          if (rbcInput) {
            rbcInput.value = currentRbc;
            searchButton.click();
          }
        });
      });
    }

    // RBCåãƒ•ã‚£ãƒ«ã‚¿å…¥åŠ›: ã‚¿ã‚¤ãƒ—ã™ã‚‹ãŸã³ã«ã‚¿ãƒ–ã‚’çµã‚Šè¾¼ã¿
    if (rbcFilterInput) {
      rbcFilterInput.addEventListener("input", () => {
        currentRbcFilter = rbcFilterInput.value || "";
        buildRbcTabs();
      });
    }

    // ============================
    // A-4: ç« ãƒ»åŸºæº–ã®ãƒ•ã‚£ãƒ«ã‚¿ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨
    // ============================
    function buildA4Filters() {
      if (!a4ChapterSelect || !rbcItems.length) return;

      // ç« ã‚»ãƒ¬ã‚¯ãƒˆã®ä¸­èº«ã‚’æ§‹ç¯‰
      const chapters = [...new Set(
        rbcItems
          .map((item) => item.chapter)
          .filter((ch) => ch && ch.trim() !== "")
      )].sort();

      // å…ˆé ­ã¯ã€Œã™ã¹ã¦ã€
      a4ChapterSelect.innerHTML =
        '<option value="">ã™ã¹ã¦</option>' +
        chapters.map((ch) => `<option value="${ch}">${ch}</option>`).join("");

      // åˆæœŸå€¤
      currentA4Chapter = "";
      currentA4Basis = a4BasisSelect ? a4BasisSelect.value : "totalAll";

      // ã‚¤ãƒ™ãƒ³ãƒˆ: ç« å¤‰æ›´
      a4ChapterSelect.addEventListener("change", () => {
        currentA4Chapter = a4ChapterSelect.value;
        renderA4RankingTable();
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆ: åŸºæº–å¤‰æ›´
      if (a4BasisSelect) {
        a4BasisSelect.addEventListener("change", () => {
          currentA4Basis = a4BasisSelect.value;
          renderA4RankingTable();
        });
      }

      // åˆå›æç”»
      renderA4RankingTable();
    }

    function renderA4RankingTable() {
      if (!a4RankingTable) return;

      let list = rbcItems.slice();

      // ç« ã§ãƒ•ã‚£ãƒ«ã‚¿
      if (currentA4Chapter) {
        list = list.filter((item) => item.chapter === currentA4Chapter);
      }

      // ã‚½ãƒ¼ãƒˆç”¨ã®ã‚¹ã‚³ã‚¢ã‚’æ±ºã‚ã‚‹
      const key = currentA4Basis || "totalAll";

      list = list
        .filter((item) => typeof item[key] === "number")
        .sort((a, b) => {
          const av = a[key] || 0;
          const bv = b[key] || 0;
          if (bv !== av) return bv - av; // é™é †
          // ã‚¹ã‚³ã‚¢ãŒåŒã˜ã¨ãã¯RBCåã§æ˜‡é †
          return (a.rbcName || "").localeCompare(b.rbcName || "");
        });

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒç©ºã®å ´åˆ
      if (!list.length) {
        a4RankingTable.innerHTML =
          '<p class="no-result">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ã¨ãªã‚‹RBCãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        if (a4RankingCount) a4RankingCount.textContent = "";
        return;
      }

      if (a4RankingCount) {
        a4RankingCount.textContent = `${list.length}ä»¶ã®RBCãŒã‚ã‚Šã¾ã™`;
      }

      const rowsHtml = list
        .map((item, index) => {
          const rank = index + 1;
          return `
            <tr onclick="goToRbcFromA4('${item.rbcName}')" style="cursor:pointer;">
              <td>${rank}</td>
              <td>${item.rbcName}</td>
              <td>${item.totalAll || 0}</td>
              <td>${item.totalAll || 0}</td>
              <td>${item.totalKishu || 0}</td>
              <td>${item.totalIppan || 0}</td>
              <td>${item.totalJokyo || 0}</td>
              <td>${item.totalOver70 || 0}</td>
            </tr>
          `;
        })
        .join("");

      const tableHtml = `
        <table>
          <thead>
            <tr>
              <th>é †ä½</th>
              <th>RBC</th>
              <th>åˆè¨ˆç‚¹æ•°</th>
              <th>åˆè¨ˆå•é¡Œæ•°</th>
              <th>å¿…ä¿®å•é¡Œæ•°</th>
              <th>ä¸€èˆ¬å•é¡Œæ•°</th>
              <th>çŠ¶æ³å•é¡Œæ•°</th>
              <th>æ­£ç­”ç‡70%ä»¥ä¸Šã®å•é¡Œæ•°</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;

      a4RankingTable.innerHTML = tableHtml;
    }

    // ============================
    // A-4: ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡Œã‚¯ãƒªãƒƒã‚¯ã§ A-2 ã®è©²å½“RBCã¸é·ç§»
    // ============================
    function goToRbcFromA4(rbcName) {
      if (!rbcName) return;
      if (rbcInput) {
        rbcInput.value = rbcName;
        showView("A2");
        searchButton.click();
      } else {
        // å¿µã®ãŸã‚
        alert("RBCæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      }
    }
    // ============================
    if (a3EditToggleButton) {
      a3EditToggleButton.addEventListener("click", () => {
        if (!currentQuestionCode) {
          alert("ç·¨é›†ã™ã‚‹å•é¡ŒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }
        const q = questions.find((item) => item.code === currentQuestionCode);
        if (!q) {
          alert(`å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ${currentQuestionCode}ï¼‰ã€‚`);
          return;
        }
        // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’åæ˜ 
        a3EditBody.value = q.body || "";
        a3EditChoice1.value = q.choices[0] || "";
        a3EditChoice2.value = q.choices[1] || "";
        a3EditChoice3.value = q.choices[2] || "";
        a3EditChoice4.value = q.choices[3] || "";
        a3EditChoice5.value = q.choices[4] || "";
        a3EditComment.value = q.comment || "";
        a3EditSection.style.display = "block";
        // ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        a3EditSection.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }

    if (a3CancelButton) {
      a3CancelButton.addEventListener("click", () => {
        a3EditSection.style.display = "none";
      });
    }

    if (a3SaveButton) {
      a3SaveButton.addEventListener("click", () => {
        if (!currentQuestionCode) {
          alert("ç·¨é›†ã™ã‚‹å•é¡ŒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }
        const q = questions.find((item) => item.code === currentQuestionCode);
        if (!q) {
          alert(`å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ${currentQuestionCode}ï¼‰ã€‚`);
          return;
        }
        // å…¥åŠ›å€¤ã§ questions é…åˆ—å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        q.body = a3EditBody.value || "";
        q.choices[0] = a3EditChoice1.value || "";
        q.choices[1] = a3EditChoice2.value || "";
        q.choices[2] = a3EditChoice3.value || "";
        q.choices[3] = a3EditChoice4.value || "";
        q.choices[4] = a3EditChoice5.value || "";
        q.comment = a3EditComment.value || "";

        // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã¦å†æç”»
        a3EditSection.style.display = "none";
        openQuestionDetail(currentQuestionCode);
      });
    }

    // ============================
    // å•é¡ŒCSV(é …ç›®.csv) ã®èª­ã¿è¾¼ã¿
    // ============================
    questionCsvInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();

      reader.onload = (e) => {
        const text = e.target.result;
        loadQuestionsFromCsv(text);
        alert("å•é¡ŒCSVï¼ˆé …ç›®.csvï¼‰ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
      };

      reader.onerror = () => {
        alert("å•é¡ŒCSV èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      };

      reader.readAsText(file, "UTF-8");
    });

    function loadQuestionsFromCsv(csvText) {
      const lines = csvText
        .split(/\r?\n/)
        .map((line) => line.trim())
        .filter((line) => line !== "");

      if (lines.length <= 1) {
        alert("å•é¡ŒCSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      const dataLines = lines.slice(1);
      questions.length = 0;

      for (const line of dataLines) {
        const cols = line.split(/\t|,/); // ã‚¿ãƒ– or ã‚«ãƒ³ãƒä¸¡å¯¾å¿œ

        const q = {
          code: cols[0] || "",                    // question_code
          rbcId: cols[1] ? Number(cols[1]) : null, // RBCï¼ˆæ•°å€¤IDï¼‰
          rbcName: cols[2] || "",                 // RBCåå‰
          environment: cols[3] || "",             // çŠ¶æ³è¨­å®šæ–‡
          body: cols[4] || "",                    // body_statement
          choices: [
            cols[5] || "", // é¸æŠè‚¢1
            cols[6] || "", // é¸æŠè‚¢2
            cols[7] || "", // é¸æŠè‚¢3
            cols[8] || "", // é¸æŠè‚¢4
            cols[9] || "", // é¸æŠè‚¢5
          ],
          answer: cols[10] || "",                 // answer
          comment: cols[11] || "",                // è§£èª¬
        };

        if (q.code && q.rbcName) {
          questions.push(q);
        }
      }

      console.log("å•é¡Œä»¶æ•°:", questions.length);
    }

    // ============================
    // 5) A-2 ã®çµæœãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    // ============================
    function renderResults(list, keyword) {
      if (list.length === 0) {
        resultsDiv.innerHTML = `<p class="no-result">"${keyword}" ã«ä¸€è‡´ã™ã‚‹RBCã®å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
        resultCount.textContent = "";
        return;
      }

      resultCount.textContent = `${list.length}ä»¶ãƒ’ãƒƒãƒˆã—ã¾ã—ãŸ`;

      const rows = list
        .map((item) => {
          return `
            <tr>
              <td>${item.id ?? ""}</td>
              <td>${item.chapter}</td>
              <td>${item.major}</td>
              <td>${item.middle}</td>
              <td>${item.rbcName}</td>

              <td>${item.totalAll}</td>
              <td>${item.totalAllRank ?? ""}</td>

              <td>${item.totalKishu}</td>
              <td>${item.totalKishuRank ?? ""}</td>

              <td>${item.totalIppan}</td>
              <td>${item.totalIppanRank ?? ""}</td>

              <td>${item.totalJokyo}</td>
              <td>${item.totalJokyoRank ?? ""}</td>
            </tr>
          `;
        })
        .join("");

      const tableHtml = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ç« </th>
              <th>å¤§é …ç›®</th>
              <th>ä¸­é …ç›®</th>
              <th>RBC(å°é …ç›®ï¼‰</th>
              <th>éå»10å¹´ã™ã¹ã¦</th>
              <th>åŒRBCrank</th>
              <th>å¿…ä¿®</th>
              <th>å¿…ä¿®rank</th>
              <th>ä¸€èˆ¬</th>
              <th>ä¸€èˆ¬rank</th>
              <th>çŠ¶æ³</th>
              <th>çŠ¶æ³rank</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      resultsDiv.innerHTML = tableHtml;
    }

    // ============================
    // æ­£ç­”ç‡CSV(æ­£ç­”ç‡.csv) ã®èª­ã¿è¾¼ã¿
    // ============================
    statsCsvInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();

      reader.onload = (e) => {
        const text = e.target.result;
        loadQuestionStatsFromCsv(text);
        alert("æ­£ç­”ç‡CSVï¼ˆæ­£ç­”ç‡.csvï¼‰ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
      };

      reader.onerror = () => {
        alert("æ­£ç­”ç‡CSV èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      };

      reader.readAsText(file, "UTF-8");
    });

    function loadQuestionStatsFromCsv(csvText) {
      const lines = csvText
        .split(/\r?\n/)
        .map((line) => line.trim())
        .filter((line) => line !== "");

      if (lines.length <= 1) {
        alert("æ­£ç­”ç‡CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      const dataLines = lines.slice(1);
      questionStats.length = 0;

      for (const line of dataLines) {
        const cols = line.split(/\t|,/); // ã‚¿ãƒ– or ã‚«ãƒ³ãƒä¸¡å¯¾å¿œ

        const s = {
          code: cols[0] || "",                    // question_code
          rate: cols[1] ? Number(cols[1]) : null, // æ­£ç­”ç‡
          choiceRates: [
            cols[2] ? Number(cols[2]) : null,     // é¸æŠç‡1
            cols[3] ? Number(cols[3]) : null,     // é¸æŠç‡2
            cols[4] ? Number(cols[4]) : null,     // é¸æŠç‡3
            cols[5] ? Number(cols[5]) : null,     // é¸æŠç‡4
            cols[6] ? Number(cols[6]) : null,     // é¸æŠç‡5
          ],
          discrimination: cols[7] ? Number(cols[7]) : null, // è­˜åˆ¥å€¤
          over70Flag: cols[8] || "",                        // 70%ä»¥ä¸Šã®ãƒ•ãƒ©ã‚°
        };

        if (s.code) {
          questionStats.push(s);
        }
      }

      console.log("æ­£ç­”ç‡ä»¶æ•°:", questionStats.length);
    }

    // ============================
    // A-2: æŒ‡å®šRBCã®å•é¡Œä¸€è¦§ã‚’æç”»ï¼ˆé …ç›®.csvãƒ™ãƒ¼ã‚¹ï¼‰
    // ============================
    function renderQuestionList(list, keyword) {
      if (!list.length) {
        resultsDiv.innerHTML = `<p class="no-result">"${keyword}" ã«å¯¾å¿œã™ã‚‹å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
        resultCount.textContent = "";
        return;
      }

      resultCount.textContent = `${list.length}ä»¶ãƒ’ãƒƒãƒˆã—ã¾ã—ãŸ`;

      const rows = list
        .map((q) => {
          const choicesHtml = q.choices
            .map((text, idx) => {
              if (!text) return "";
              return `${idx + 1}. ${text}`;
            })
            .filter((s) => s !== "")
            .join("<br />");

          const stat = questionStats.find((s) => s.code === q.code) || null;
          const rateText = stat && stat.rate != null ? `${stat.rate}%` : "";
          const discrText =
            stat && stat.discrimination != null ? `${stat.discrimination}` : "";

          return `
            <tr onclick="openQuestionDetail('${q.code}')">
              <td>${q.code}</td>
              <td>${q.environment || ""}</td>
              <td>${q.body || ""}</td>
              <td>${choicesHtml}</td>
              <td>${rateText}</td>
              <td>${discrText}</td>
            </tr>
          `;
        })
        .join("");

      const tableHtml = `
        <table>
          <thead>
            <tr>
              <th>å•é¡Œç•ªå·</th>
              <th>çŠ¶æ³è¨­å®šæ–‡</th>
              <th>å•é¡Œæ–‡</th>
              <th>é¸æŠè‚¢</th>
              <th>æ­£ç­”ç‡</th>
              <th>è­˜åˆ¥å€¤</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      resultsDiv.innerHTML = tableHtml;
    }

    // ============================
    // A-3: å•é¡Œè©³ç´°ç”»é¢ã¸é·ç§»ã—ã¦æç”»
    // ============================
    function openQuestionDetail(code) {
      currentQuestionCode = code;

      const q = questions.find((item) => item.code === code);
      if (!q) {
        alert(`å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ${code}ï¼‰ã€‚`);
        return;
      }

      // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã¯æ–°ã—ã„å•é¡Œã‚’é–‹ã„ãŸã¨ãã«ã¯é–‰ã˜ã¦ãŠã
      if (a3EditSection) {
        a3EditSection.style.display = "none";
      }

      const stat = questionStats.find((s) => s.code === code) || null;

      // å•é¡Œç•ªå·
      a3Code.textContent = code;

      // å•é¡Œæ–‡ï¼ˆHTMLã‚¿ã‚°ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ innerHTML ã‚’ä½¿ã†ï¼‰
      a3Body.innerHTML = q.body || "";

      // é¸æŠè‚¢ + é¸æŠç‡
      const choiceRates = stat ? stat.choiceRates : [];
      const itemsHtml = q.choices
        .map((text, idx) => {
          if (!text) return "";
          const rate = choiceRates && choiceRates[idx] != null
            ? `${choiceRates[idx]}%`
            : "";
          const rateText = rate ? `ï¼ˆ${rate}ï¼‰` : "";
          return `<li>${idx + 1}. ${text}${rateText}</li>`;
        })
        .join("");

      a3Choices.innerHTML = itemsHtml;

      // æ­£ç­”ç‡
      if (stat && stat.rate != null) {
        a3Rate.textContent = `${stat.rate}%`;
      } else {
        a3Rate.textContent = "æ­£ç­”ç‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
      }

      // è§£èª¬: <ex>ã€œ</ex> ã‚’æ®µè½ã«å¤‰æ›ã—ã¦è¡¨ç¤º
      let commentHtml = q.comment || "";
      commentHtml = commentHtml.replace(/<ex>/g, "<p>").replace(/<\/ex>/g, "</p>");
      a3Comment.innerHTML = commentHtml;

      // ç”»é¢ã‚’ A-3 ã«åˆ‡ã‚Šæ›¿ãˆ
      showView("A3");
    }
  </script>
</script>
</body>
</html>